<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pushup Counter Pro</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Poppins', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#FF6B6B',
                        accent: '#4ECDC4',
                        success: '#10B981',
                        warning: '#F59E0B',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                },
            },
        }
    </script>
    <style>
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.3);
            transform: scale(0);
            animation: ripple-animation 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confetti 4s ease-in-out forwards;
            pointer-events: none;
        }
        
        .progress-ring {
            transition: stroke-dashoffset 0.3s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        html {
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            overscroll-behavior: none;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
        }
        
        .user-badge {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .user-badge.active::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background-color: #10B981;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .dark .user-badge.active::after {
            border-color: #1F2937;
        }
        
        @keyframes pushup {
            0% { transform: translateY(0); }
            50% { transform: translateY(8px); }
            100% { transform: translateY(0); }
        }
        
        .pushup-animation {
            animation: pushup 1s ease;
        }
        
        @keyframes live-pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .live-indicator {
            animation: live-pulse 2s ease infinite;
        }
        
        @keyframes cheer {
            0% { transform: scale(1); }
            50% { transform: scale(1.5) rotate(10deg); }
            100% { transform: scale(1); }
        }
        
        .cheer-animation {
            animation: cheer 1s ease-in-out;
        }
        
        .panel-content {
            scrollbar-width: thin;
            scrollbar-color: rgba(93, 92, 222, 0.5) transparent;
        }
        
        .panel-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .panel-content::-webkit-scrollbar-thumb {
            background-color: rgba(93, 92, 222, 0.5);
            border-radius: 6px;
        }
        
        @keyframes slide-in {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes slide-out {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        
        .slide-in {
            animation: slide-in 0.3s forwards;
        }
        
        .slide-out {
            animation: slide-out 0.3s forwards;
        }
        
        @keyframes badge-unlock {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .badge-unlock {
            animation: badge-unlock 0.5s forwards;
        }
        
        .mode-card {
            transition: all 0.3s ease;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
        }
        
        .badge {
            position: relative;
            overflow: hidden;
        }
        
        .badge::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #FF6B6B, #5D5CDE, #4ECDC4, #F59E0B);
            background-size: 400% 400%;
            animation: gradient 5s ease infinite;
            z-index: -1;
            border-radius: 50%;
            opacity: 0.5;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .badge.unlocked::after {
            content: '✓';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background-color: #10B981;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge.locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        
        .calendar-day {
            position: relative;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .calendar-day.has-workout::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #5D5CDE;
            border-radius: 50%;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #5D5CDE;
        }
        
        .toggle-checkbox:checked + .toggle-label {
            background-color: #5D5CDE;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        .challenge-input {
            @apply w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary;
        }
        
        .paused {
            position: relative;
        }
        
        .paused::after {
            content: '';
            position: absolute;
            inset: -5px;
            border: 2px dashed #FF6B6B;
            border-radius: 1rem;
            animation: pulse 2s infinite;
            pointer-events: none;
        }
        
        body.is-paused {
            overflow: auto !important;
        }
        
        .custom-goal-container {
            @apply flex items-center space-x-2 mt-2 w-full;
        }
        
        .custom-goal-input {
            @apply flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-base focus:outline-none focus:ring-2 focus:ring-primary;
        }
        
        .toast-message {
            z-index: 9999;
        }
        
        .time-remaining {
            @apply text-xs px-2 py-0.5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-400 inline-flex items-center;
        }
        
        .quick-goal-btn {
            @apply px-3 py-1 rounded-lg text-sm font-medium transition-colors;
        }
        
        .quick-goal-btn.active {
            @apply bg-primary text-white;
        }
        
        .profile-badge-container {
            @apply grid grid-cols-3 gap-3;
        }
        
        .profile-badge-item {
            @apply flex flex-col items-center;
        }
        
        .weekly-chart-container {
            position: relative;
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .dark .weekly-chart-container {
            background: #374151;
        }
        
        .weekly-chart-title {
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            z-index: 10;
        }
        
        .weekly-chart-bars {
            display: flex;
            align-items: end;
            justify-content: space-between;
            height: 8rem;
            margin-top: 2.5rem;
        }
        
        .counter-display-enhanced {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(78, 205, 196, 0.1));
            border-radius: 2rem;
            padding: 2rem;
            margin: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(93, 92, 222, 0.2);
        }
        
        @keyframes counter-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        .counter-pop {
            animation: counter-pop 0.3s ease-out;
        }
        
        @keyframes suspicious-warning {
            0% { background-color: rgba(255, 107, 107, 0.1); }
            50% { background-color: rgba(255, 107, 107, 0.3); }
            100% { background-color: rgba(255, 107, 107, 0.1); }
        }
        
        .suspicious-activity {
            animation: suspicious-warning 0.5s ease-in-out;
        }
        
        .motivational-message {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(16, 185, 129, 0.2));
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .user-avatar-enhanced {
            position: relative;
        }
        
        .user-avatar-enhanced::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #5D5CDE, #4ECDC4, #5D5CDE);
            animation: rotate 3s linear infinite;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .user-avatar-enhanced.active::before {
            opacity: 1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="m-0 p-0 h-screen w-screen font-sans bg-white text-gray-800 dark:bg-gray-900 dark:text-white transition-colors duration-300">
    <div id="counter-app" class="flex flex-col items-center pt-16 md:pt-24 h-full w-full relative overflow-hidden">
        <!-- Top Bar -->
        <div class="absolute top-0 left-0 right-0 flex justify-between items-center px-4 py-2 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm z-30 shadow-sm">
            <div class="flex items-center space-x-3">
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1 text-primary" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"></path>
                    </svg>
                    <span id="timer" class="font-mono">00:00</span>
                </div>
                
                <div class="flex items-center bg-gray-200 dark:bg-gray-800 px-2 py-0.5 rounded-full">
                    <span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-1 live-indicator"></span>
                    <span class="text-xs font-medium">LIVE</span>
                    <span id="online-count" class="ml-1 bg-gray-300 dark:bg-gray-700 px-1.5 rounded-full text-xs font-bold">0</span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="pause-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Pause/Resume Counter">
                    <i class="fas fa-play text-gray-600 dark:text-gray-300"></i>
                </button>
                <button id="leaderboard-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Leaderboard">
                    <i class="fas fa-trophy text-gray-600 dark:text-gray-300"></i>
                </button>
                <button id="fullscreen-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Fullscreen">
                    <i class="fas fa-expand text-gray-600 dark:text-gray-300"></i>
                </button>
                <button id="challenges-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Challenges">
                    <i class="fas fa-flag text-gray-600 dark:text-gray-300"></i>
                </button>
                <button id="profile-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Profile">
                    <i class="fas fa-user text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
        </div>

        <!-- Live Users Avatars -->
        <div id="users-container" class="absolute top-14 right-4 flex flex-col items-end space-y-2 z-20">
        </div>

        <!-- Main Counter Display -->
        <div class="counter-display-enhanced">
            <div id="counter-display" class="text-9xl md:text-[12rem] font-bold transition-all duration-300 transform select-none text-center">0</div>
        </div>
        
        <!-- Messages Below Counter -->
        <div class="mt-4 w-full max-w-xs text-center">
            <div id="sassy-message" class="hidden mb-2 max-w-xs bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 p-3 rounded-lg text-sm font-medium border border-red-200 dark:border-red-800 mx-auto">
                Don't cheat! Your nose should touch the screen at the bottom of each pushup.
            </div>
            
            <div id="motivational-message" class="hidden mb-2 max-w-xs motivational-message text-accent-dark dark:text-accent p-3 rounded-lg text-sm font-medium mx-auto">
                Great form! Keep pushing yourself! 💪
            </div>
        </div>
        
        <!-- Progress Ring -->
        <div class="mt-4 relative">
            <svg width="120" height="120" class="transform rotate-90">
                <circle cx="60" cy="60" r="54" fill="transparent" stroke="#e2e8f0" stroke-width="8" class="dark:stroke-gray-700"></circle>
                <circle id="progress-ring" cx="60" cy="60" r="54" fill="transparent" stroke="#5D5CDE" stroke-width="8" 
                        stroke-dasharray="339.29" stroke-dashoffset="339.29" class="progress-ring"></circle>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-sm font-medium">GOAL: <span id="goal-display">100</span></div>
            </div>
        </div>
        
        <!-- Daily Challenge Banner -->
        <div id="challenge-banner" class="mt-3 hidden bg-gradient-to-r from-primary/20 to-accent/20 rounded-lg px-4 py-2 text-center">
            <div class="text-xs uppercase font-semibold text-primary">Daily Challenge</div>
            <div id="challenge-text" class="text-sm font-medium">Do 100 pushups today!</div>
            <div class="flex items-center justify-center mt-1">
                <div class="bg-gray-200 dark:bg-gray-700 h-2 rounded-full w-full max-w-[150px]">
                    <div id="challenge-progress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Stats Row -->
        <div class="mt-4 grid grid-cols-3 gap-4 text-center w-full max-w-xs">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-2">
                <div class="text-xs text-gray-500 dark:text-gray-400">SESSION</div>
                <div id="session-count" class="text-xl font-bold">0</div>
            </div>
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-2">
                <div class="text-xs text-gray-500 dark:text-gray-400">TODAY</div>
                <div id="today-count" class="text-xl font-bold">0</div>
            </div>
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-2">
                <div class="text-xs text-gray-500 dark:text-gray-400">TOTAL</div>
                <div id="total-count" class="text-xl font-bold">0</div>
            </div>
        </div>
        
        <!-- Live Activity Feed -->
        <div id="activity-feed" class="mt-4 w-full max-w-xs bg-gray-100 dark:bg-gray-800 rounded-lg h-24 flex flex-col overflow-hidden">
            <div class="text-xs text-gray-500 dark:text-gray-400 text-center py-1 border-b border-gray-200 dark:border-gray-700">LIVE ACTIVITY</div>
            <div id="feed-container" class="space-y-1 overflow-y-auto p-2 flex-1 panel-content">
                <div class="text-center text-xs text-gray-500 dark:text-gray-400 initial-message">Connecting to workout network...</div>
            </div>
        </div>
        
        <!-- Control Buttons -->
        <div class="absolute bottom-6 w-full flex justify-center space-x-3 z-20">
            <button id="goal-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                <i class="fas fa-flag mr-1"></i> Goal
            </button>
            <button id="reset-btn" class="px-4 py-2 bg-primary text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                <i class="fas fa-redo-alt mr-1"></i> Reset
            </button>
            <button id="share-btn" class="px-4 py-2 bg-accent text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                <i class="fas fa-share-alt mr-1"></i> Share
            </button>
        </div>
        
        <!-- Connection Status -->
        <div id="connection-status" class="absolute bottom-20 left-0 right-0 text-center text-sm font-medium text-gray-600 dark:text-gray-400 opacity-100 transition-opacity">
            <span class="inline-block px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-800">
                <span id="connection-icon" class="inline-block w-2 h-2 rounded-full bg-yellow-500 animate-pulse-fast mr-1"></span>
                <span id="connection-text">Connecting...</span>
            </span>
        </div>
        
        <!-- Username Modal -->
        <div id="username-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-11/12 max-w-md">
                <h3 class="text-xl font-bold mb-4">Enter Your Name</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Choose a name to show other users during your workout</p>
                <input type="text" id="username-input" maxlength="15" placeholder="Your name" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-base mb-4">
                <div class="flex justify-end">
                    <button id="username-submit" class="px-4 py-2 bg-primary text-white rounded-lg">Start Workout</button>
                </div>
            </div>
        </div>
        
        <!-- Welcome Message -->
        <div id="welcome-message" class="fixed inset-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm flex flex-col items-center justify-center z-40 transition-opacity duration-500">
            <div class="text-center p-6 max-w-md">
                <div class="mb-6">
                    <div class="w-20 h-20 mx-auto bg-primary rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-dumbbell text-3xl text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-4 text-primary">Pushup Counter Pro</h2>
                </div>
                <p class="mb-4 text-gray-700 dark:text-gray-300">Touch or tap the screen with your nose at the bottom of each pushup!</p>
                
                <div class="mb-6 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-bold mb-2 text-gray-800 dark:text-white">Quick Tips:</h3>
                    <ul class="text-sm text-left text-gray-700 dark:text-gray-300 space-y-1">
                        <li>• Place your device on the floor where your nose will touch it</li>
                        <li>• Use the pause button if you need to scroll or take a break</li>
                        <li>• Create and join community challenges to stay motivated</li>
                        <li>• Compete on the leaderboard with real users in real-time</li>
                        <li>• <span class="text-red-500 dark:text-red-400 font-medium">Don't cheat!</span> This app has smart cheat detection</li>
                    </ul>
                </div>
                
                <button id="start-workout" class="px-6 py-3 bg-primary text-white rounded-full text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                    Start Workout
                </button>
            </div>
        </div>
        
        <!-- Achievement Toast -->
        <div id="achievement-toast" class="fixed top-16 left-1/2 transform -translate-x-1/2 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300 pointer-events-none toast-message">
            <div class="flex items-center">
                <i class="fas fa-trophy mr-2"></i>
                <span id="achievement-text">Great job!</span>
            </div>
        </div>
        
        <!-- Cheer Toast -->
        <div id="cheer-toast" class="fixed top-28 left-1/2 transform -translate-x-1/2 bg-accent text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300 pointer-events-none toast-message">
            <div class="flex items-center">
                <i class="fas fa-thumbs-up mr-2"></i>
                <span id="cheer-text">Someone cheered you on!</span>
            </div>
        </div>
        
        <!-- Custom Goal Modal -->
        <div id="custom-goal-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-11/12 max-w-md">
                <h3 class="text-xl font-bold mb-4">Set Your Goal</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Choose a target number of pushups for this session</p>
                
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button class="quick-goal-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white" data-goal="20">20</button>
                    <button class="quick-goal-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white" data-goal="50">50</button>
                    <button class="quick-goal-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white" data-goal="100">100</button>
                    <button class="quick-goal-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white" data-goal="200">200</button>
                    <button class="quick-goal-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white" data-goal="500">500</button>
                    <button class="quick-goal-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white" data-goal="1000">1000</button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Custom Goal</label>
                    <div class="flex space-x-2">
                        <input type="number" id="custom-goal-input" min="1" max="9999" placeholder="Enter pushups" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-base">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button id="cancel-custom-goal" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg">Cancel</button>
                    <button id="save-custom-goal" class="px-4 py-2 bg-primary text-white rounded-lg">Set Goal</button>
                </div>
            </div>
        </div>
        
        <!-- Leaderboard Modal -->
        <div id="leaderboard-modal" class="fixed inset-0 z-50 pointer-events-none">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
            <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold">Leaderboard</h3>
                    <button id="close-leaderboard" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <button id="tab-today" class="flex-1 py-3 px-2 text-sm font-medium border-b-2 border-primary text-primary">Today</button>
                    <button id="tab-week" class="flex-1 py-3 px-2 text-sm font-medium text-gray-500 dark:text-gray-400">This Week</button>
                    <button id="tab-month" class="flex-1 py-3 px-2 text-sm font-medium text-gray-500 dark:text-gray-400">This Month</button>
                </div>
                
                <div class="flex-1 overflow-y-auto panel-content">
                    <div id="leaderboard-today" class="p-4 space-y-3">
                        <div id="leaderboard-today-loading" class="flex items-center justify-center p-4">
                            <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div id="leaderboard-week" class="p-4 space-y-3 hidden">
                        <div id="leaderboard-week-loading" class="flex items-center justify-center p-4">
                            <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div id="leaderboard-month" class="p-4 space-y-3 hidden">
                        <div id="leaderboard-month-loading" class="flex items-center justify-center p-4">
                            <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <div class="text-sm font-medium mb-2">Your Stats</div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Today's Rank:</span>
                            <span id="your-rank-today" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">Weekly Rank:</span>
                            <span id="your-rank-week" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">Monthly Rank:</span>
                            <span id="your-rank-month" class="font-bold">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenges Modal -->
        <div id="challenges-modal" class="fixed inset-0 z-50 pointer-events-none">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
            <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold">Challenges</h3>
                    <button id="close-challenges" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="flex border-b border-gray-200 dark:border-gray-700">
                    <button id="tab-active-challenges" class="flex-1 py-3 px-2 text-sm font-medium border-b-2 border-primary text-primary">Active</button>
                    <button id="tab-community-challenges" class="flex-1 py-3 px-2 text-sm font-medium text-gray-500 dark:text-gray-400">Community</button>
                    <button id="tab-create-challenge" class="flex-1 py-3 px-2 text-sm font-medium text-gray-500 dark:text-gray-400">Create</button>
                </div>
                
                <div class="flex-1 overflow-y-auto panel-content">
                    <div id="active-challenges" class="p-4 space-y-4">
                        <div id="active-challenges-loading" class="flex items-center justify-center p-4">
                            <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div id="community-challenges" class="p-4 space-y-4 hidden">
                        <div id="community-challenges-loading" class="flex items-center justify-center p-4">
                            <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div id="create-challenge" class="p-4 space-y-4 hidden">
                        <div class="bg-white dark:bg-gray-700 rounded-lg p-5 shadow">
                            <h4 class="font-medium mb-4">Create a New Challenge</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Challenge Name</label>
                                    <input type="text" id="challenge-name" placeholder="Give your challenge a name" class="challenge-input px-4 py-3">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Description</label>
                                    <textarea id="challenge-description" rows="2" placeholder="Describe your challenge" class="challenge-input px-4 py-3"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Target (Pushups)</label>
                                    <input type="number" id="challenge-target" placeholder="100" min="1" max="1000" class="challenge-input px-4 py-3">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">End Date</label>
                                    <input type="date" id="challenge-end-date" class="challenge-input px-4 py-3">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="challenge-public" class="rounded border-gray-300 text-primary focus:ring-primary mr-2">
                                    <label for="challenge-public" class="text-sm">Make this challenge public (community)</label>
                                </div>
                                
                                <button id="submit-challenge" class="w-full py-3 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                    Create Challenge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Modal -->
        <div id="profile-modal" class="fixed inset-0 z-50 pointer-events-none">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
            <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold">Your Profile</h3>
                    <button id="close-profile" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Profile Header -->
                <div class="p-6 bg-gradient-to-r from-primary to-accent flex items-center space-x-4">
                    <div class="w-20 h-20 rounded-full bg-white text-primary text-3xl font-bold flex items-center justify-center shadow-lg" id="profile-avatar">
                        A
                    </div>
                    <div class="text-white">
                        <h2 class="text-xl font-bold" id="profile-name"></h2>
                        <p class="text-white/80" id="profile-level">Level 1 Pusher</p>
                        <div class="mt-1 bg-white/20 h-2 rounded-full w-full max-w-[150px]">
                            <div id="profile-level-progress" class="bg-white h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-white/80 mt-1" id="profile-xp">0/100 XP to Level 2</p>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 dark:border-gray-700">
                    <button id="tab-profile-stats" class="flex-1 py-3 text-sm font-medium border-b-2 border-primary text-primary">Stats</button>
                    <button id="tab-profile-badges" class="flex-1 py-3 text-sm font-medium text-gray-500 dark:text-gray-400">Badges</button>
                    <button id="tab-profile-history" class="flex-1 py-3 text-sm font-medium text-gray-500 dark:text-gray-400">History</button>
                    <button id="tab-profile-settings" class="flex-1 py-3 text-sm font-medium text-gray-500 dark:text-gray-400">Settings</button>
                </div>
                
                <!-- Profile Content -->
                <div class="flex-1 overflow-y-auto panel-content">
                    <!-- Stats Tab -->
                    <div id="profile-stats" class="p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Today</p>
                                <p class="text-2xl font-bold" id="profile-today-count">0</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Total</p>
                                <p class="text-2xl font-bold" id="profile-total-count">0</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Streak</p>
                                <p class="text-2xl font-bold" id="profile-streak-count">0</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Max in a Day</p>
                                <p class="text-2xl font-bold" id="profile-max-count">0</p>
                            </div>
                        </div>
                        
                        <div class="weekly-chart-container">
                            <h4 class="weekly-chart-title">Weekly Progress</h4>
                            <div id="weekly-chart" class="weekly-chart-bars">
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium mb-3">Statistics</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Average pushups per day:</span>
                                    <span class="font-medium" id="profile-avg-pushups">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Challenges completed:</span>
                                    <span class="font-medium" id="profile-challenges-completed">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Longest streak:</span>
                                    <span class="font-medium" id="profile-longest-streak">0 days</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Total time spent:</span>
                                    <span class="font-medium" id="profile-total-time">0 minutes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Badges Tab -->
                    <div id="profile-badges" class="p-4 hidden">
                        <div class="grid grid-cols-3 gap-4">
                        </div>
                    </div>
                    
                    <!-- History Tab -->
                    <div id="profile-history" class="p-4 hidden">
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">Workout Calendar</h4>
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <button id="prev-month" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="font-medium" id="calendar-month">Loading...</div>
                                    <button id="next-month" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-7 gap-1 text-center">
                                    <div class="text-xs text-gray-500 dark:text-gray-400">S</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">M</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">T</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">W</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">T</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">F</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">S</div>
                                    
                                    <div id="calendar-grid" class="col-span-7 grid grid-cols-7 gap-1"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-2">Recent Workouts</h4>
                            <div id="recent-workouts" class="space-y-3">
                                <div class="text-center text-sm text-gray-500 dark:text-gray-400">Loading workouts...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="profile-settings" class="p-4 hidden">
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow">
                                <h4 class="font-medium mb-4">Account</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Your Name</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="settings-username" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
                                            <button id="save-username-btn" class="px-4 py-2 bg-primary text-white rounded-lg">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow">
                                <h4 class="font-medium mb-4">Appearance</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Theme</label>
                                        <div class="flex space-x-2">
                                            <button id="theme-light-btn" class="flex-1 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg flex items-center justify-center">
                                                <i class="fas fa-sun mr-2"></i> Light
                                            </button>
                                            <button id="theme-dark-btn" class="flex-1 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg flex items-center justify-center">
                                                <i class="fas fa-moon mr-2"></i> Dark
                                            </button>
                                            <button id="theme-auto-btn" class="flex-1 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg flex items-center justify-center">
                                                <i class="fas fa-sync mr-2"></i> Auto
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow">
                                <h4 class="font-medium mb-4">Sound Effects</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">Enable sounds</span>
                                        <div class="relative inline-block w-12 align-middle select-none">
                                            <input type="checkbox" id="sound-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-0"/>
                                            <label for="sound-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">Volume</span>
                                        <input type="range" id="volume-slider" min="0" max="100" value="50" class="w-1/2">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow">
                                <h4 class="font-medium mb-4">Workout Settings</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Default Goal</label>
                                        <select id="default-goal" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
                                            <option value="20">20 pushups</option>
                                            <option value="50">50 pushups</option>
                                            <option value="100" selected>100 pushups</option>
                                            <option value="200">200 pushups</option>
                                            <option value="500">500 pushups</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">Show smart cheat detection</span>
                                        <div class="relative inline-block w-12 align-middle select-none">
                                            <input type="checkbox" id="anticheat-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-0" checked/>
                                            <label for="anticheat-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow">
                                <h4 class="font-medium mb-4">Privacy</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">Show my badges to others</span>
                                        <div class="relative inline-block w-12 align-middle select-none">
                                            <input type="checkbox" id="privacy-badges-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-0" checked/>
                                            <label for="privacy-badges-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">Show my activity to others</span>
                                        <div class="relative inline-block w-12 align-middle select-none">
                                            <input type="checkbox" id="privacy-activity-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-0" checked/>
                                            <label for="privacy-activity-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow">
                                <h4 class="font-medium mb-4 text-red-500 dark:text-red-400">Danger Zone</h4>
                                <div class="space-y-4">
                                    <button id="clear-data-btn" class="w-full py-2 px-4 bg-red-500 text-white rounded-lg flex items-center justify-center">
                                        <i class="fas fa-trash mr-2"></i> Clear My Data
                                    </button>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        This will permanently delete all your workout history, challenges, and settings. This cannot be undone.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-center text-xs text-gray-500 dark:text-gray-400">
                    Pushup Counter Pro v1.2.0
                </div>
            </div>
        </div>
        
        <!-- User Profile View Modal -->
        <div id="user-profile-view-modal" class="fixed inset-0 z-50 pointer-events-none">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
            <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold">User Profile</h3>
                    <button id="close-user-profile-view" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6 bg-gradient-to-r from-primary to-accent flex items-center space-x-4">
                    <div class="w-20 h-20 rounded-full bg-white text-primary text-3xl font-bold flex items-center justify-center shadow-lg" id="user-profile-avatar">
                        A
                    </div>
                    <div class="text-white">
                        <h2 class="text-xl font-bold" id="user-profile-name">Anonymous</h2>
                        <p class="text-white/80" id="user-profile-level">Level 1 Pusher</p>
                        <p class="text-xs text-white/80 mt-1" id="user-profile-status">Currently Online</p>
                    </div>
                </div>
                
                <div class="p-4">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Today</p>
                            <p class="text-2xl font-bold" id="user-profile-today-count">0</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Total</p>
                            <p class="text-2xl font-bold" id="user-profile-total-count">0</p>
                        </div>
                    </div>
                    
                    <h4 class="font-medium mb-3">Current Goal</h4>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-6">
                        <div class="flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-600 h-2 rounded-full flex-1">
                                <div id="user-profile-progress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="user-profile-goal" class="ml-2 text-sm font-medium">0/100</div>
                        </div>
                    </div>
                    
                    <h4 class="font-medium mb-3">Badges</h4>
                    <div id="user-profile-badges" class="grid grid-cols-3 gap-3 mb-6">
                    </div>
                    
                    <h4 class="font-medium mb-3">Recent Activity</h4>
                    <div id="user-profile-activity" class="space-y-2 bg-gray-50 dark:bg-gray-700 rounded-lg p-3 max-h-36 overflow-y-auto panel-content">
                        <div class="text-center text-sm text-gray-500 dark:text-gray-400">Loading activity...</div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 grid grid-cols-2 gap-3">
                    <button id="cheer-user-profile-btn" class="py-2 bg-accent text-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-thumbs-up mr-2"></i>
                        Cheer
                    </button>
                    <button id="share-user-profile-btn" class="py-2 bg-primary text-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-share-alt mr-2"></i>
                        Share
                    </button>
                </div>
            </div>
        </div>
        
        <!-- User Details Modal -->
        <div id="user-details-modal" class="fixed inset-0 z-50 pointer-events-none">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
            <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold">User Details</h3>
                    <button id="close-user-details" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto panel-content p-4">
                    <div class="flex items-center">
                        <div id="user-details-avatar" class="w-16 h-16 rounded-full flex items-center justify-center text-white text-xl font-bold bg-primary">
                            A
                        </div>
                        <div class="ml-4">
                            <div id="user-details-name" class="text-lg font-bold">Anonymous</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Currently Online</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-500 dark:text-gray-400">TODAY</div>
                            <div id="user-details-today" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-500 dark:text-gray-400">TOTAL</div>
                            <div id="user-details-total" class="text-xl font-bold">0</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                        <div class="text-sm font-medium mb-2">Current Goal</div>
                        <div class="flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-600 h-2 rounded-full flex-1">
                                <div id="user-details-progress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="user-details-goal" class="ml-2 text-sm font-medium">0/100</div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="text-sm font-medium mb-2">Recent Activity</div>
                        <div id="user-details-activity" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-h-36 overflow-y-auto panel-content space-y-2">
                            <div class="text-center text-sm text-gray-500 dark:text-gray-400">Loading activity...</div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 grid grid-cols-2 gap-3">
                    <button id="cheer-user-btn" class="py-2 bg-accent text-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-thumbs-up mr-2"></i>
                        Cheer
                    </button>
                    <button id="view-profile-btn" class="py-2 bg-primary text-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-user mr-2"></i>
                        View Profile
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-11/12 max-w-md">
                <h3 id="confirm-title" class="text-xl font-bold mb-2">Confirmation</h3>
                <p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to continue?</p>
                
                <div class="flex justify-end space-x-2">
                    <button id="cancel-confirm" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg">Cancel</button>
                    <button id="ok-confirm" class="px-4 py-2 bg-red-500 text-white rounded-lg">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Full Screen Touch Area -->
        <div id="touch-area" class="absolute inset-0 z-10 cursor-pointer"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, remove, onValue, onChildAdded, onChildChanged, onChildRemoved, onDisconnect, serverTimestamp, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAl_iGa6bfxH_4anUJL6SIntE3DcdR-l9Y",
            authDomain: "pushupscounter-5e11a.firebaseapp.com",
            projectId: "pushupscounter-5e11a",
            storageBucket: "pushupscounter-5e11a.firebasestorage.app",
            messagingSenderId: "439744700710",
            appId: "1:439744700710:web:dce1a83c64d664f73d21e7",
            databaseURL: "https://pushupscounter-5e11a-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // DOM Elements
        const counterDisplay = document.getElementById('counter-display');
        const touchArea = document.getElementById('touch-area');
        const resetBtn = document.getElementById('reset-btn');
        const goalBtn = document.getElementById('goal-btn');
        const shareBtn = document.getElementById('share-btn');
        const timerDisplay = document.getElementById('timer');
        const sessionCountDisplay = document.getElementById('session-count');
        const todayCountDisplay = document.getElementById('today-count');
        const totalCountDisplay = document.getElementById('total-count');
        const progressRing = document.getElementById('progress-ring');
        const goalDisplay = document.getElementById('goal-display');
        const onlineCountDisplay = document.getElementById('online-count');
        const usersContainer = document.getElementById('users-container');
        const feedContainer = document.getElementById('feed-container');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const challengesBtn = document.getElementById('challenges-btn');
        const profileBtn = document.getElementById('profile-btn');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const usernameSubmit = document.getElementById('username-submit');
        const welcomeMessage = document.getElementById('welcome-message');
        const startWorkout = document.getElementById('start-workout');
        const connectionStatus = document.getElementById('connection-status');
        const connectionIcon = document.getElementById('connection-icon');
        const connectionText = document.getElementById('connection-text');
        const achievementToast = document.getElementById('achievement-toast');
        const achievementText = document.getElementById('achievement-text');
        const cheerToast = document.getElementById('cheer-toast');
        const cheerText = document.getElementById('cheer-text');
        const pauseToggle = document.getElementById('pause-toggle');
        const challengeBanner = document.getElementById('challenge-banner');
        const challengeText = document.getElementById('challenge-text');
        const challengeProgress = document.getElementById('challenge-progress');
        const sassyMessage = document.getElementById('sassy-message');
        const motivationalMessage = document.getElementById('motivational-message');
        const customGoalModal = document.getElementById('custom-goal-modal');
        const customGoalInput = document.getElementById('custom-goal-input');
        const saveCustomGoal = document.getElementById('save-custom-goal');
        const cancelCustomGoal = document.getElementById('cancel-custom-goal');
        const quickGoalBtns = document.querySelectorAll('.quick-goal-btn');
        
        const privacyBadgesToggle = document.getElementById('privacy-badges-toggle');
        const privacyActivityToggle = document.getElementById('privacy-activity-toggle');
        
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const closeLeaderboard = document.getElementById('close-leaderboard');
        const challengesModal = document.getElementById('challenges-modal');
        const closeChallenges = document.getElementById('close-challenges');
        const profileModal = document.getElementById('profile-modal');
        const closeProfile = document.getElementById('close-profile');
        const userDetailsModal = document.getElementById('user-details-modal');
        const closeUserDetails = document.getElementById('close-user-details');
        const confirmModal = document.getElementById('confirm-modal');
        const userProfileViewModal = document.getElementById('user-profile-view-modal');
        const closeUserProfileView = document.getElementById('close-user-profile-view');
        
        const tabToday = document.getElementById('tab-today');
        const tabWeek = document.getElementById('tab-week');
        const tabMonth = document.getElementById('tab-month');
        const leaderboardToday = document.getElementById('leaderboard-today');
        const leaderboardWeek = document.getElementById('leaderboard-week');
        const leaderboardMonth = document.getElementById('leaderboard-month');
        
        const tabActiveChallenges = document.getElementById('tab-active-challenges');
        const tabCommunityChallenges = document.getElementById('tab-community-challenges');
        const tabCreateChallenge = document.getElementById('tab-create-challenge');
        const activeChallenges = document.getElementById('active-challenges');
        const communityChallenges = document.getElementById('community-challenges');
        const createChallenge = document.getElementById('create-challenge');
        
        const tabProfileStats = document.getElementById('tab-profile-stats');
        const tabProfileBadges = document.getElementById('tab-profile-badges');
        const tabProfileHistory = document.getElementById('tab-profile-history');
        const tabProfileSettings = document.getElementById('tab-profile-settings');
        const profileStats = document.getElementById('profile-stats');
        const profileBadges = document.getElementById('profile-badges');
        const profileHistory = document.getElementById('profile-history');
        const profileSettings = document.getElementById('profile-settings');
        
        const soundToggle = document.getElementById('sound-toggle');
        const volumeSlider = document.getElementById('volume-slider');
        const defaultGoalSelect = document.getElementById('default-goal');
        const anticheatToggle = document.getElementById('anticheat-toggle');
        const themeLightBtn = document.getElementById('theme-light-btn');
        const themeDarkBtn = document.getElementById('theme-dark-btn');
        const themeAutoBtn = document.getElementById('theme-auto-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const settingsUsername = document.getElementById('settings-username');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        
        const userProfileViewName = document.getElementById('user-profile-name');
        const userProfileViewAvatar = document.getElementById('user-profile-avatar');
        const userProfileViewLevel = document.getElementById('user-profile-level');
        const userProfileViewStatus = document.getElementById('user-profile-status');
        const userProfileViewTodayCount = document.getElementById('user-profile-today-count');
        const userProfileViewTotalCount = document.getElementById('user-profile-total-count');
        const userProfileViewProgress = document.getElementById('user-profile-progress');
        const userProfileViewGoal = document.getElementById('user-profile-goal');
        const userProfileViewBadges = document.getElementById('user-profile-badges');
        const userProfileViewActivity = document.getElementById('user-profile-activity');
        const cheerUserProfileBtn = document.getElementById('cheer-user-profile-btn');
        const shareUserProfileBtn = document.getElementById('share-user-profile-btn');
        
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const cancelConfirm = document.getElementById('cancel-confirm');
        const okConfirm = document.getElementById('ok-confirm');
        
        const challengeName = document.getElementById('challenge-name');
        const challengeDescription = document.getElementById('challenge-description');
        const challengeTargetInput = document.getElementById('challenge-target');
        const challengeEndDate = document.getElementById('challenge-end-date');
        const challengePublic = document.getElementById('challenge-public');
        const submitChallenge = document.getElementById('submit-challenge');
        
        // Variables
        let count = 0;
        let touchActive = false;
        let touchTimeout = null;
        let timerInterval = null;
        let seconds = 0;
        let goal = 100;
        let todayCount = 0;
        let totalCount = 0;
        let streak = 0;
        let maxPushups = 0;
        let username = '';
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let userRef = null;
        let onlineUsers = {};
        let leaderboardData = {today: [], week: [], month: []};
        let currentUserDetails = null;
        let currentProfileView = null;
        let activeChallengeId = null;
        let challengeTarget = 0;
        let challengeCompleted = false;
        let isPaused = false;
        let isSoundEnabled = true;
        let volume = 0.5;
        let showAnticheatReminders = true;
        let userLevel = 1;
        let userXp = 0;
        let workoutDays = {};
        let challengesCompleted = 0;
        let longestStreak = 0;
        let totalTimeSpent = 0;
        let confirmedCallback = null;
        let badgesUnlocked = [];
        let firstJoinDate = null;
        let privacyShowBadges = true;
        let privacyShowActivity = true;
        let selectedCustomGoal = null;
        
        // Enhanced cheat detection
        let lastTapTime = 0;
        let tapHistory = [];
        let suspiciousActivityCount = 0;
        let lastMotivationalTime = 0;
        let totalCheersGiven = 0;
        
        const sassyMessages = [
            "Whoa there, speed racer! Real pushups take more than 0.5 seconds! 🚨",
            "That's some superhuman speed... unless you're tapping with your finger! 👀",
            "Slow down! Quality over quantity - do proper pushups! 💪",
            "Your future self will thank you for doing REAL pushups, not rapid taps.",
            "The only person you're cheating is yourself. Slow down and do proper form!",
            "Detected impossible speed! Your nose can't move that fast! 🤔",
            "Those rapid taps aren't fooling anyone. Do proper pushups!",
            "Real pushups require going down AND coming back up! That takes time!",
            "Cheating at pushups is like photoshopping your gym selfies. We all know.",
            "Your muscles can't be fooled even if the app can. Do real pushups!",
            "Take your time - proper form is more important than speed! 🏃‍♂️➡️🚶‍♂️",
            "Remember: this app has smart cheat detection. Be honest! 🧠",
        ];
        
        const motivationalMessages = [
            "Perfect form! Keep pushing yourself! 💪",
            "Great technique! You're crushing it! 🔥",
            "Excellent pace! That's how it's done! ⭐",
            "Beautiful pushup! Feel that burn! 🌟",
            "Outstanding form! Your dedication shows! 🏆",
            "Keep that rhythm going! You're amazing! 🎵",
            "Textbook pushup! Professional form! 📚",
            "Incredible control! Master level technique! 🥋",
            "Perfect timing! You've got this dialed in! ⏰",
            "Elite athlete form! Absolutely impressive! 🥇",
            "That's what proper pushups look like! 👏",
            "Consistent excellence! You're unstoppable! 🚀",
        ];
        
        const badgeDefinitions = [
            { id: 'first_pushup', name: 'First Push', icon: 'fa-play', requirement: 'Complete your first pushup' },
            { id: 'century', name: '100 Club', icon: 'fa-hundred-points', requirement: 'Complete 100 pushups in total' },
            { id: 'dedication', name: 'Dedicated', icon: 'fa-calendar-check', requirement: 'Work out for 7 days in a row' },
            { id: 'challenge_master', name: 'Challenge Master', icon: 'fa-medal', requirement: 'Complete 3 challenges' },
            { id: 'iron_chest', name: 'Iron Chest', icon: 'fa-dumbbell', requirement: 'Complete 50 pushups in one session' },
            { id: 'early_bird', name: 'Early Bird', icon: 'fa-sun', requirement: 'Work out before 8 AM' },
            { id: 'night_owl', name: 'Night Owl', icon: 'fa-moon', requirement: 'Work out after 10 PM' },
            { id: 'pushup_machine', name: 'Pushup Machine', icon: 'fa-robot', requirement: 'Complete 1,000 pushups total' },
            { id: 'marathon', name: 'Marathon', icon: 'fa-running', requirement: 'Complete 100 pushups in one session' },
            { id: 'social', name: 'Social Butterfly', icon: 'fa-users', requirement: 'Cheer for 5 different users' },
        ];
        
        function createBeepSound(frequency = 800, duration = 100, type = 'sine') {
            if (!isSoundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            } catch (e) {
                console.warn('Audio context not available');
            }
        }
        
        function loadSavedData() {
            if (localStorage.getItem('pushup_username')) {
                username = localStorage.getItem('pushup_username');
            }
            
            if (!localStorage.getItem('pushup_first_join')) {
                firstJoinDate = new Date().toISOString();
                localStorage.setItem('pushup_first_join', firstJoinDate);
            } else {
                firstJoinDate = localStorage.getItem('pushup_first_join');
            }
            
            if (localStorage.getItem('pushup_today')) {
                const savedDate = localStorage.getItem('pushup_date');
                const today = new Date().toDateString();
                
                if (savedDate === today) {
                    todayCount = parseInt(localStorage.getItem('pushup_today')) || 0;
                    todayCountDisplay.textContent = todayCount;
                } else {
                    localStorage.setItem('pushup_date', today);
                    localStorage.setItem('pushup_today', '0');
                    
                    if (savedDate && parseInt(localStorage.getItem('pushup_today')) > 0) {
                        recordWorkoutDay(savedDate, parseInt(localStorage.getItem('pushup_today')));
                    }
                    
                    todayCount = 0;
                }
            } else {
                localStorage.setItem('pushup_date', new Date().toDateString());
                localStorage.setItem('pushup_today', '0');
            }
            
            if (localStorage.getItem('pushup_total')) {
                totalCount = parseInt(localStorage.getItem('pushup_total')) || 0;
                totalCountDisplay.textContent = totalCount;
            } else {
                localStorage.setItem('pushup_total', '0');
            }
            
            if (localStorage.getItem('pushup_streak')) {
                streak = parseInt(localStorage.getItem('pushup_streak')) || 0;
            } else {
                localStorage.setItem('pushup_streak', '0');
            }
            
            if (localStorage.getItem('pushup_max')) {
                maxPushups = parseInt(localStorage.getItem('pushup_max')) || 0;
            } else {
                localStorage.setItem('pushup_max', '0');
            }
            
            if (localStorage.getItem('pushup_workout_days')) {
                try {
                    workoutDays = JSON.parse(localStorage.getItem('pushup_workout_days')) || {};
                } catch (e) {
                    workoutDays = {};
                }
            } else {
                localStorage.setItem('pushup_workout_days', JSON.stringify({}));
            }
            
            if (localStorage.getItem('pushup_challenges_completed')) {
                challengesCompleted = parseInt(localStorage.getItem('pushup_challenges_completed')) || 0;
            } else {
                localStorage.setItem('pushup_challenges_completed', '0');
            }
            
            if (localStorage.getItem('pushup_longest_streak')) {
                longestStreak = parseInt(localStorage.getItem('pushup_longest_streak')) || 0;
            } else {
                localStorage.setItem('pushup_longest_streak', '0');
            }
            
            if (localStorage.getItem('pushup_total_time')) {
                totalTimeSpent = parseInt(localStorage.getItem('pushup_total_time')) || 0;
            } else {
                localStorage.setItem('pushup_total_time', '0');
            }
            
            if (localStorage.getItem('pushup_level')) {
                userLevel = parseInt(localStorage.getItem('pushup_level')) || 1;
            } else {
                localStorage.setItem('pushup_level', '1');
            }
            
            if (localStorage.getItem('pushup_xp')) {
                userXp = parseInt(localStorage.getItem('pushup_xp')) || 0;
            } else {
                localStorage.setItem('pushup_xp', '0');
            }
            
            if (localStorage.getItem('pushup_badges')) {
                try {
                    badgesUnlocked = JSON.parse(localStorage.getItem('pushup_badges')) || [];
                } catch (e) {
                    badgesUnlocked = [];
                }
            } else {
                localStorage.setItem('pushup_badges', JSON.stringify([]));
            }
            
            if (localStorage.getItem('pushup_sound_enabled') !== null) {
                isSoundEnabled = localStorage.getItem('pushup_sound_enabled') === 'true';
                soundToggle.checked = isSoundEnabled;
            }
            
            if (localStorage.getItem('pushup_volume')) {
                volume = parseFloat(localStorage.getItem('pushup_volume')) || 0.5;
                volumeSlider.value = volume * 100;
            }
            
            if (localStorage.getItem('pushup_goal')) {
                goal = parseInt(localStorage.getItem('pushup_goal')) || 100;
                goalDisplay.textContent = goal;
                defaultGoalSelect.value = goal.toString();
            }
            
            if (localStorage.getItem('pushup_anticheat') !== null) {
                showAnticheatReminders = localStorage.getItem('pushup_anticheat') === 'true';
                anticheatToggle.checked = showAnticheatReminders;
            }
            
            if (localStorage.getItem('pushup_privacy_badges') !== null) {
                privacyShowBadges = localStorage.getItem('pushup_privacy_badges') === 'true';
                privacyBadgesToggle.checked = privacyShowBadges;
            }
            
            if (localStorage.getItem('pushup_privacy_activity') !== null) {
                privacyShowActivity = localStorage.getItem('pushup_privacy_activity') === 'true';
                privacyActivityToggle.checked = privacyShowActivity;
            }
        }
        
        function recordWorkoutDay(dateStr, count) {
            workoutDays[dateStr] = count;
            localStorage.setItem('pushup_workout_days', JSON.stringify(workoutDays));
        }
        
        function updateProfileScreen() {
            document.getElementById('profile-name').textContent = username;
            document.getElementById('profile-avatar').textContent = username.charAt(0).toUpperCase();
            document.getElementById('profile-today-count').textContent = todayCount;
            document.getElementById('profile-total-count').textContent = totalCount;
            document.getElementById('profile-streak-count').textContent = streak;
            document.getElementById('profile-max-count').textContent = maxPushups;
            document.getElementById('profile-level').textContent = `Level ${userLevel} Pusher`;
            
            const nextLevelXp = userLevel * 100;
            const percentage = Math.min(100, (userXp / nextLevelXp) * 100);
            document.getElementById('profile-level-progress').style.width = `${percentage}%`;
            document.getElementById('profile-xp').textContent = `${userXp}/${nextLevelXp} XP to Level ${userLevel + 1}`;
            
            const daysSinceJoined = Math.max(1, Math.floor((Date.now() - new Date(firstJoinDate).getTime()) / (1000 * 60 * 60 * 24)));
            const avgPushups = Math.round(totalCount / daysSinceJoined);
            document.getElementById('profile-avg-pushups').textContent = avgPushups;
            
            document.getElementById('profile-challenges-completed').textContent = challengesCompleted;
            document.getElementById('profile-longest-streak').textContent = `${longestStreak} days`;
            
            const totalMinutes = Math.floor(totalTimeSpent / 60);
            document.getElementById('profile-total-time').textContent = `${totalMinutes} minutes`;
            
            updateWeeklyChart();
            updateBadges();
            updateCalendar();
            updateRecentWorkouts();
        }
        
        function updateWeeklyChart() {
            const weeklyChart = document.getElementById('weekly-chart');
            weeklyChart.innerHTML = '';
            
            const dates = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                dates.push(date.toDateString());
            }
            
            const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let maxValue = 1;
            for (const dateStr of dates) {
                const count = workoutDays[dateStr] || 0;
                maxValue = Math.max(maxValue, count);
            }
            
            for (let i = 0; i < 7; i++) {
                const dateStr = dates[i];
                const count = workoutDays[dateStr] || 0;
                const percentage = (count / maxValue) * 100;
                const height = Math.max(5, percentage);
                
                const isToday = dateStr === new Date().toDateString();
                
                const barContainer = document.createElement('div');
                barContainer.className = 'flex flex-col items-center justify-end h-full';
                barContainer.style.width = '12%';
                
                barContainer.innerHTML = `
                    <div class="w-8 bg-gray-200 dark:bg-gray-600 rounded-t-md relative overflow-hidden flex-shrink-0" style="height: ${Math.max(20, (height / 100) * 120)}px;">
                        <div class="absolute bottom-0 w-full ${isToday ? 'bg-accent' : 'bg-primary'} ${isToday && count === 0 ? 'animate-pulse' : ''}" style="height: 100%;"></div>
                    </div>
                    <p class="text-xs mt-1 font-medium">${dayLabels[new Date(dateStr).getDay()]}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${count}</p>
                `;
                
                weeklyChart.appendChild(barContainer);
            }
        }
        
        function updateBadges() {
            const badgesContainer = document.getElementById('profile-badges');
            badgesContainer.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-3 gap-4';
            
            for (const badge of badgeDefinitions) {
                const isUnlocked = badgesUnlocked.includes(badge.id);
                
                const badgeEl = document.createElement('div');
                badgeEl.className = `badge ${isUnlocked ? 'unlocked' : 'locked'} flex flex-col items-center`;
                
                badgeEl.innerHTML = `
                    <div class="w-16 h-16 rounded-full ${isUnlocked ? 'bg-primary/20' : 'bg-gray-300 dark:bg-gray-700'} flex items-center justify-center mb-1">
                        <i class="fas ${badge.icon} ${isUnlocked ? 'text-primary' : 'text-gray-400 dark:text-gray-600'} text-xl"></i>
                    </div>
                    <p class="text-xs font-medium text-center">${badge.name}</p>
                `;
                
                badgeEl.title = badge.requirement;
                
                grid.appendChild(badgeEl);
            }
            
            badgesContainer.appendChild(grid);
        }
        
        function updateCalendar() {
            const calendarMonth = document.getElementById('calendar-month');
            const calendarGrid = document.getElementById('calendar-grid');
            
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            calendarMonth.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            calendarGrid.innerHTML = '';
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day h-8 flex items-center justify-center text-xs text-gray-400';
                calendarGrid.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const dateStr = new Date(currentYear, currentMonth, day).toDateString();
                const hasWorkout = workoutDays[dateStr] ? true : false;
                
                dayEl.className = `calendar-day h-8 flex items-center justify-center text-xs ${hasWorkout ? 'has-workout font-bold' : ''}`;
                
                if (day === currentDate.getDate() && currentMonth === currentDate.getMonth() && currentYear === currentDate.getFullYear()) {
                    dayEl.classList.add('bg-primary/20', 'rounded-full');
                }
                
                dayEl.textContent = day;
                
                if (hasWorkout) {
                    dayEl.title = `${workoutDays[dateStr]} pushups`;
                }
                
                calendarGrid.appendChild(dayEl);
            }
        }
        
        function updateRecentWorkouts() {
            const recentWorkouts = document.getElementById('recent-workouts');
            recentWorkouts.innerHTML = '';
            
            const sortedDays = Object.keys(workoutDays).sort((a, b) => {
                return new Date(b).getTime() - new Date(a).getTime();
            });
            
            const recentDays = sortedDays.slice(0, 5);
            
            if (recentDays.length === 0) {
                recentWorkouts.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No workout history yet</div>';
                return;
            }
            
            for (const dateStr of recentDays) {
                const count = workoutDays[dateStr];
                const date = new Date(dateStr);
                
                let formattedDate;
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    formattedDate = 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    formattedDate = 'Yesterday';
                } else {
                    formattedDate = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
                }
                
                const workoutEl = document.createElement('div');
                workoutEl.className = 'bg-white dark:bg-gray-700 p-3 rounded-lg';
                
                workoutEl.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${formattedDate}</span>
                        <span class="text-primary font-medium">${count} pushups</span>
                    </div>
                `;
                
                recentWorkouts.appendChild(workoutEl);
            }
        }
        
        const circumference = 2 * Math.PI * 54;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
        progressRing.style.strokeDashoffset = circumference;
        
        function updateProgressRing() {
            const offset = circumference - (count / goal) * circumference;
            progressRing.style.strokeDashoffset = offset;
        }
        
        function setThemePreference() {
            const themePreference = localStorage.getItem('color-theme');
            
            if (themePreference === 'dark' || 
                (!themePreference && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else if (themePreference === 'light') {
                document.documentElement.classList.remove('dark');
            }
            
            if (themePreference === 'dark') {
                highlightThemeButton('dark');
            } else if (themePreference === 'light') {
                highlightThemeButton('light');
            } else {
                highlightThemeButton('auto');
            }
        }
        
        function highlightThemeButton(theme) {
            [themeLightBtn, themeDarkBtn, themeAutoBtn].forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-white');
            });
            
            if (theme === 'light') {
                themeLightBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-white');
                themeLightBtn.classList.add('bg-primary', 'text-white');
            } else if (theme === 'dark') {
                themeDarkBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-white');
                themeDarkBtn.classList.add('bg-primary', 'text-white');
            } else {
                themeAutoBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-white');
                themeAutoBtn.classList.add('bg-primary', 'text-white');
            }
        }
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            seconds = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                seconds++;
                updateTimerDisplay();
                
                if (seconds % 60 === 0) {
                    totalTimeSpent += 60;
                    localStorage.setItem('pushup_total_time', totalTimeSpent.toString());
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        function playSound(soundName) {
            if (!isSoundEnabled) return;
            
            try {
                switch (soundName) {
                    case 'count':
                        createBeepSound(600, 80, 'sine');
                        break;
                    case 'achievement':
                        setTimeout(() => createBeepSound(523, 100, 'sine'), 0);
                        setTimeout(() => createBeepSound(659, 100, 'sine'), 100);
                        setTimeout(() => createBeepSound(784, 200, 'sine'), 200);
                        break;
                    case 'cheer':
                        createBeepSound(800, 150, 'triangle');
                        setTimeout(() => createBeepSound(1000, 150, 'triangle'), 150);
                        break;
                    case 'levelUp':
                        setTimeout(() => createBeepSound(523, 150, 'sine'), 0);
                        setTimeout(() => createBeepSound(659, 150, 'sine'), 0);
                        setTimeout(() => createBeepSound(784, 150, 'sine'), 0);
                        setTimeout(() => createBeepSound(1047, 300, 'sine'), 150);
                        break;
                    case 'click':
                        createBeepSound(400, 50, 'square');
                        break;
                    case 'challengeComplete':
                        setTimeout(() => createBeepSound(523, 100, 'sine'), 0);
                        setTimeout(() => createBeepSound(659, 100, 'sine'), 100);
                        setTimeout(() => createBeepSound(784, 100, 'sine'), 200);
                        setTimeout(() => createBeepSound(1047, 200, 'sine'), 300);
                        break;
                    default:
                        createBeepSound(500, 100, 'sine');
                }
            } catch (error) {
                console.warn(`Error creating sound "${soundName}":`, error);
            }
        }
        
        function isValidPushup(currentTime) {
            tapHistory.push(currentTime);
            
            if (tapHistory.length > 10) {
                tapHistory.shift();
            }
            
            if (lastTapTime > 0 && (currentTime - lastTapTime) < 800) {
                suspiciousActivityCount++;
                return false;
            }
            
            if (tapHistory.length >= 5) {
                let quickTapsCount = 0;
                for (let i = 1; i < Math.min(5, tapHistory.length); i++) {
                    if (tapHistory[i] - tapHistory[i-1] < 1000) {
                        quickTapsCount++;
                    }
                }
                
                if (quickTapsCount >= 4) {
                    suspiciousActivityCount++;
                    return false;
                }
            }
            
            if (suspiciousActivityCount > 0) {
                suspiciousActivityCount--;
            }
            
            return true;
        }
        
        function showMotivationalMessage() {
            if (Date.now() - lastMotivationalTime < 10000) return;
            
            const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            motivationalMessage.textContent = randomMessage;
            
            motivationalMessage.classList.remove('hidden');
            
            setTimeout(() => {
                motivationalMessage.classList.add('hidden');
            }, 3000);
            
            lastMotivationalTime = Date.now();
        }
        
        function checkBadges() {
            const newBadges = [];
            
            if (totalCount > 0 && !badgesUnlocked.includes('first_pushup')) {
                newBadges.push('first_pushup');
            }
            
            if (totalCount >= 100 && !badgesUnlocked.includes('century')) {
                newBadges.push('century');
            }
            
            if (streak >= 7 && !badgesUnlocked.includes('dedication')) {
                newBadges.push('dedication');
            }
            
            if (challengesCompleted >= 3 && !badgesUnlocked.includes('challenge_master')) {
                newBadges.push('challenge_master');
            }
            
            if (count >= 50 && !badgesUnlocked.includes('iron_chest')) {
                newBadges.push('iron_chest');
            }
            
            const currentHour = new Date().getHours();
            if (currentHour < 8 && !badgesUnlocked.includes('early_bird')) {
                newBadges.push('early_bird');
            }
            
            if (currentHour >= 22 && !badgesUnlocked.includes('night_owl')) {
                newBadges.push('night_owl');
            }
            
            if (totalCount >= 1000 && !badgesUnlocked.includes('pushup_machine')) {
                newBadges.push('pushup_machine');
            }
            
            if (count >= 100 && !badgesUnlocked.includes('marathon')) {
                newBadges.push('marathon');
            }
            
            if (totalCheersGiven >= 5 && !badgesUnlocked.includes('social')) {
                newBadges.push('social');
            }
            
            for (const badgeId of newBadges) {
                if (!badgesUnlocked.includes(badgeId)) {
                    badgesUnlocked.push(badgeId);
                    
                    const badge = badgeDefinitions.find(b => b.id === badgeId);
                    if (badge) {
                        showAchievement(`Badge Unlocked: ${badge.name}!`);
                        playSound('achievement');
                        
                        addXP(50);
                    }
                }
            }
            
            localStorage.setItem('pushup_badges', JSON.stringify(badgesUnlocked));
        }
        
        function addXP(amount) {
            userXp += amount;
            
            const xpForNextLevel = userLevel * 100;
            if (userXp >= xpForNextLevel) {
                userLevel++;
                userXp -= xpForNextLevel;
                
                localStorage.setItem('pushup_level', userLevel.toString());
                localStorage.setItem('pushup_xp', userXp.toString());
                
                showAchievement(`Level Up! You're now Level ${userLevel}!`);
                playSound('levelUp');
                
                if (profileModal.classList.contains('pointer-events-auto')) {
                    updateProfileScreen();
                }
                
                return true;
            }
            
            localStorage.setItem('pushup_xp', userXp.toString());
            
            if (profileModal.classList.contains('pointer-events-auto')) {
                updateProfileScreen();
            }
            
            return false;
        }
        
        function incrementCounter(eventX, eventY) {
            if (isPaused) return;
            
            const currentTime = Date.now();
            
            if (showAnticheatReminders && !isValidPushup(currentTime)) {
                counterDisplay.classList.add('suspicious-activity');
                setTimeout(() => {
                    counterDisplay.classList.remove('suspicious-activity');
                }, 500);
                
                if (suspiciousActivityCount >= 3) {
                    showSassyMessage();
                    suspiciousActivityCount = 0;
                }
                
                return;
            }
            
            if (Math.random() < 0.15 && count > 5) {
                showMotivationalMessage();
            }
            
            lastTapTime = currentTime;
            
            count++;
            todayCount++;
            totalCount++;
            
            if (todayCount > maxPushups) {
                maxPushups = todayCount;
                localStorage.setItem('pushup_max', maxPushups.toString());
            }
            
            counterDisplay.textContent = count;
            sessionCountDisplay.textContent = count;
            todayCountDisplay.textContent = todayCount;
            totalCountDisplay.textContent = totalCount;
            
            localStorage.setItem('pushup_today', todayCount.toString());
            localStorage.setItem('pushup_total', totalCount.toString());
            
            recordWorkoutDay(new Date().toDateString(), todayCount);
            
            updateProgressRing();
            updateChallengeProgress();
            
            playSound('count');
            
            checkAchievements();
            checkBadges();
            addXP(1);
            
            createRippleEffect(eventX, eventY);
            
            counterDisplay.classList.add('counter-pop', 'text-primary');
            setTimeout(() => {
                counterDisplay.classList.remove('counter-pop', 'text-primary');
            }, 300);
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: true,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                }).then(() => {
                    setTimeout(() => {
                        if (userRef) {
                            set(userRef, {
                                username: username,
                                count: count,
                                todayCount: todayCount,
                                totalCount: totalCount,
                                goal: goal,
                                lastActive: Date.now(),
                                pushup: false,
                                level: userLevel,
                                badges: badgesUnlocked,
                                privacyShowBadges: privacyShowBadges,
                                privacyShowActivity: privacyShowActivity
                            });
                        }
                    }, 1000);
                });
                
                addPushupActivity(userId, username, count);
                updateUserStats();
            }
        }
        
        function showSassyMessage() {
            const randomMessage = sassyMessages[Math.floor(Math.random() * sassyMessages.length)];
            sassyMessage.textContent = randomMessage;
            
            sassyMessage.classList.remove('hidden');
            sassyMessage.classList.add('shake-animation');
            
            setTimeout(() => {
                sassyMessage.classList.remove('shake-animation');
                sassyMessage.classList.add('hidden');
            }, 5000);
        }
        
        function createRippleEffect(x, y) {
            const posX = x || window.innerWidth / 2;
            const posY = y || window.innerHeight / 2;
            
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.width = '100px';
            ripple.style.height = '100px';
            ripple.style.left = `${posX - 50}px`;
            ripple.style.top = `${posY - 50}px`;
            
            document.body.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 1000);
        }
        
        function createConfetti() {
            const colors = ['#5D5CDE', '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
        }
        
        function checkAchievements() {
            if (count === goal) {
                streak++;
                localStorage.setItem('pushup_streak', streak.toString());
                
                if (streak > longestStreak) {
                    longestStreak = streak;
                    localStorage.setItem('pushup_longest_streak', longestStreak.toString());
                }
                
                showAchievement(`Goal reached! ${goal} pushups!`);
                playSound('achievement');
                createConfetti();
                addActivityMessage(`You reached your goal of ${goal} pushups! 🎉`, 'achievement');
            } else if (count === 10) {
                showAchievement('Great start! 10 pushups!');
                playSound('achievement');
            } else if (count === 50) {
                showAchievement('Halfway there! Keep going!');
                playSound('achievement');
            } else if (count === 200) {
                showAchievement('Incredible! 200 pushups!');
                playSound('achievement');
            } else if (count % 25 === 0) {
                showAchievement(`${count} pushups completed!`);
                playSound('achievement');
            }
            
            if (activeChallengeId && todayCount >= challengeTarget && !challengeCompleted) {
                showAchievement('Daily Challenge completed! 🏆');
                playSound('challengeComplete');
                createConfetti();
                addActivityMessage('You completed today\'s challenge! 🏆', 'achievement');
                challengeCompleted = true;
                
                challengesCompleted++;
                localStorage.setItem('pushup_challenges_completed', challengesCompleted.toString());
                
                addXP(25);
            }
        }
        
        function showAchievement(message) {
            achievementText.textContent = message;
            achievementToast.classList.add('opacity-100');
            
            setTimeout(() => {
                achievementToast.classList.remove('opacity-100');
            }, 3000);
        }
        
        function showCheer(message) {
            cheerText.textContent = message;
            cheerToast.classList.add('opacity-100');
            
            playSound('cheer');
            
            setTimeout(() => {
                cheerToast.classList.remove('opacity-100');
            }, 3000);
        }
        
        function handleTouchStart(e) {
            if (isPaused) return;
            
            e.preventDefault();
            
            if (!touchActive) {
                touchActive = true;
                
                const touch = e.type.includes('touch') ? e.touches[0] : e;
                const x = touch.clientX;
                const y = touch.clientY;
                
                incrementCounter(x, y);
                
                touchTimeout = setTimeout(() => {
                    touchActive = false;
                }, 500);
            }
        }
        
        function handleTouchEnd(e) {
            if (isPaused) return;
            e.preventDefault();
        }
        
        function initFirebase() {
            connectionStatus.classList.add('opacity-100');
            connectionIcon.classList.add('animate-pulse-fast', 'bg-yellow-500');
            connectionText.textContent = 'Connecting...';
            
            const activeUsersRef = ref(db, 'active_users');
            const activitiesRef = ref(db, 'activities');
            const statsRef = ref(db, 'stats');
            const challengesRef = ref(db, 'challenges');
            
            userRef = ref(db, `active_users/${userId}`);
            
            set(userRef, {
                username: username,
                count: count,
                todayCount: todayCount,
                totalCount: totalCount,
                goal: goal,
                lastActive: Date.now(),
                pushup: false,
                level: userLevel,
                badges: badgesUnlocked,
                privacyShowBadges: privacyShowBadges,
                privacyShowActivity: privacyShowActivity
            }).then(() => {
                onDisconnect(userRef).remove();
                
                connectionIcon.classList.remove('animate-pulse-fast', 'bg-yellow-500');
                connectionIcon.classList.add('bg-green-500');
                connectionText.textContent = 'Connected';
                
                setTimeout(() => {
                    connectionStatus.classList.remove('opacity-100');
                }, 2000);
                
                removeInitialMessage();
                addActivityMessage('You joined the workout!', 'system');
                
                addUserElement(userId, username, true);
                
                checkForActiveChallenge();
                updateUserStats();
                updateProfileScreen();
                
                playSound('click');
            }).catch(error => {
                console.error("Firebase error:", error);
                connectionIcon.classList.remove('animate-pulse-fast', 'bg-yellow-500');
                connectionIcon.classList.add('bg-red-500');
                connectionText.textContent = 'Connection failed';
            });
            
            onChildAdded(activeUsersRef, (snapshot) => {
                const userData = snapshot.val();
                const uid = snapshot.key;
                
                if (uid === userId) return;
                
                onlineUsers[uid] = userData;
                
                addUserElement(uid, userData.username);
                updateOnlineCount();
                addActivityMessage(`${userData.username} joined the workout!`, 'join');
            });
            
            onChildChanged(activeUsersRef, (snapshot) => {
                const userData = snapshot.val();
                const uid = snapshot.key;
                
                if (uid === userId) return;
                
                onlineUsers[uid] = userData;
                
                if (userData.pushup) {
                    animateUserPushup(uid);
                }
                
                if (currentUserDetails === uid) {
                    updateUserDetailsUI(userData);
                }
                
                if (currentProfileView === uid) {
                    updateUserProfileView(userData);
                }
            });
            
            onChildRemoved(activeUsersRef, (snapshot) => {
                const uid = snapshot.key;
                const userData = onlineUsers[uid];
                
                if (uid === userId) return;
                
                if (userData) {
                    addActivityMessage(`${userData.username} left the workout!`, 'leave');
                    
                    delete onlineUsers[uid];
                    removeUserElement(uid);
                    updateOnlineCount();
                    
                    if (currentUserDetails === uid) {
                        hideUserDetailsModal();
                    }
                    
                    if (currentProfileView === uid) {
                        hideUserProfileView();
                    }
                }
            });
            
            onChildAdded(activitiesRef, (snapshot) => {
                const activity = snapshot.val();
                
                if (Date.now() - activity.timestamp > 30000) return;
                
                if (activity.userId === userId) return;
                
                if (activity.type === 'pushup') {
                    addActivityMessage(`${activity.username} did a pushup! (${activity.count})`, 'pushup');
                } else if (activity.type === 'cheer' && activity.targetUserId === userId) {
                    showCheer(`${activity.username} cheered you on!`);
                    addActivityMessage(`${activity.username} cheered you on! 👍`, 'cheer');
                }
            });
            
            onValue(ref(db, 'stats'), (snapshot) => {
                if (snapshot.exists()) {
                    updateLeaderboardData(snapshot.val());
                }
            });
            
            onValue(ref(db, 'challenges'), (snapshot) => {
                if (snapshot.exists()) {
                    const challenges = snapshot.val();
                    updateChallengesUI(challenges);
                }
            });
        }
        
        function updateChallengeProgress() {
            if (activeChallengeId && challengeTarget > 0) {
                const percentage = Math.min(100, (todayCount / challengeTarget) * 100);
                challengeProgress.style.width = `${percentage}%`;
            }
        }
        
        function checkForActiveChallenge() {
            const today = new Date().toISOString().split('T')[0];
            
            get(ref(db, 'challenges')).then((snapshot) => {
                if (snapshot.exists()) {
                    const challenges = snapshot.val();
                    
                    for (const id in challenges) {
                        const challenge = challenges[id];
                        if (challenge.date === today && challenge.active) {
                            activeChallengeId = id;
                            challengeTarget = challenge.target;
                            
                            challengeText.textContent = challenge.description || `Do ${challenge.target} pushups today!`;
                            updateChallengeProgress();
                            challengeBanner.classList.remove('hidden');
                            
                            challengeCompleted = todayCount >= challengeTarget;
                            break;
                        }
                    }
                } else {
                    createDailyChallenge();
                }
            });
        }
        
        function createDailyChallenge() {
            const today = new Date().toISOString().split('T')[0];
            
            const target = Math.floor(Math.random() * 251) + 50;
            
            const newChallengeRef = push(ref(db, 'challenges'));
            set(newChallengeRef, {
                name: "Daily Challenge",
                description: `Complete ${target} pushups today!`,
                date: today,
                endDate: today,
                target: target,
                active: true,
                createdBy: userId,
                createdByUsername: username,
                public: true,
                createdAt: serverTimestamp()
            }).then(() => {
                activeChallengeId = newChallengeRef.key;
                challengeTarget = target;
                
                challengeText.textContent = `Complete ${target} pushups today!`;
                updateChallengeProgress();
                challengeBanner.classList.remove('hidden');
                
                challengeCompleted = false;
            });
        }
        
        function getTimeRemaining(endDate) {
            const now = new Date();
            const end = new Date(endDate + 'T23:59:59');
            const diffTime = end - now;
            
            if (diffTime <= 0) {
                return 'Ended';
            }
            
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (diffDays > 0) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} left`;
            } else if (diffHours > 0) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} left`;
            } else {
                return 'Ending soon';
            }
        }
        
        function updateChallengesUI(challenges) {
            const activeContainer = document.getElementById('active-challenges');
            const activeLoadingElement = document.getElementById('active-challenges-loading');
            if (activeLoadingElement) {
                activeLoadingElement.remove();
            }
            
            const communityContainer = document.getElementById('community-challenges');
            const communityLoadingElement = document.getElementById('community-challenges-loading');
            if (communityLoadingElement) {
                communityLoadingElement.remove();
            }
            
            if (!challenges || Object.keys(challenges).length === 0) {
                activeContainer.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No active challenges</div>';
                communityContainer.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No community challenges available</div>';
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            const activeList = [];
            const communityList = [];
            
            for (const id in challenges) {
                const challenge = challenges[id];
                challenge.id = id;
                
                const isActive = challenge.endDate >= today;
                const isPublic = challenge.public === true;
                const isCreatedByUser = challenge.createdBy === userId;
                
                if (isActive && (isCreatedByUser || activeChallengeId === id)) {
                    activeList.push(challenge);
                } else if (isActive && isPublic && !isCreatedByUser) {
                    communityList.push(challenge);
                }
            }
            
            if (activeList.length === 0) {
                activeContainer.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No active challenges</div>';
            } else {
                activeContainer.innerHTML = '';
                
                activeList.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                
                for (const challenge of activeList) {
                    const isCompleted = challenge.target <= todayCount;
                    const percentage = Math.min(100, (todayCount / challenge.target) * 100);
                    const timeRemaining = getTimeRemaining(challenge.endDate);
                    
                    const challengeEl = document.createElement('div');
                    challengeEl.className = 'bg-white dark:bg-gray-700 rounded-lg p-4 shadow';
                    
                    const startDate = new Date(challenge.date);
                    const endDate = new Date(challenge.endDate);
                    const startFormatted = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
                    const endFormatted = `${endDate.getMonth() + 1}/${endDate.getDate()}`;
                    const dateRange = challenge.date === challenge.endDate ? startFormatted : `${startFormatted} - ${endFormatted}`;
                    
                    challengeEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-medium">${challenge.name || 'Challenge'}</h5>
                                <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${challenge.description}</p>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-xs text-gray-500 dark:text-gray-400">${dateRange}</span>
                                    <span class="time-remaining">${timeRemaining}</span>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${isCompleted ? 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400' : 'bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400'}">${isCompleted ? 'Completed' : 'Active'}</span>
                        </div>
                        <div class="flex items-center mb-1">
                            <div class="flex-1 bg-gray-200 dark:bg-gray-600 h-2 rounded-full">
                                <div class="bg-primary h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="ml-2 text-xs font-medium">${Math.round(percentage)}%</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">${todayCount}/${challenge.target} pushups</span>
                            ${challenge.createdBy === userId ? `
                                <button class="delete-challenge-btn text-xs text-red-500 hover:underline" data-challenge-id="${challenge.id}">
                                    Delete Challenge
                                </button>
                            ` : ''}
                        </div>
                    `;
                    
                    activeContainer.appendChild(challengeEl);
                    
                    const deleteButton = challengeEl.querySelector('.delete-challenge-btn');
                    if (deleteButton) {
                        deleteButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            const challengeId = e.target.getAttribute('data-challenge-id');
                            showConfirmation('Delete Challenge', 'Are you sure you want to delete this challenge?', () => {
                                deleteChallenge(challengeId);
                            });
                        });
                    }
                }
            }
            
            if (communityList.length === 0) {
                communityContainer.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No community challenges available</div>';
            } else {
                communityContainer.innerHTML = '';
                
                communityList.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                
                for (const challenge of communityList) {
                    const isCompleted = challenge.target <= todayCount;
                    const percentage = Math.min(100, (todayCount / challenge.target) * 100);
                    const timeRemaining = getTimeRemaining(challenge.endDate);
                    
                    const challengeEl = document.createElement('div');
                    challengeEl.className = 'bg-white dark:bg-gray-700 rounded-lg p-4 shadow';
                    
                    const startDate = new Date(challenge.date);
                    const endDate = new Date(challenge.endDate);
                    const startFormatted = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
                    const endFormatted = `${endDate.getMonth() + 1}/${endDate.getDate()}`;
                    const dateRange = challenge.date === challenge.endDate ? startFormatted : `${startFormatted} - ${endFormatted}`;
                    
                    challengeEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-medium">${challenge.name || 'Community Challenge'}</h5>
                                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">${challenge.description}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Created by: ${challenge.createdByUsername || 'Anonymous'}</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-xs text-gray-500 dark:text-gray-400">${dateRange}</span>
                                    <span class="time-remaining">${timeRemaining}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center mt-2 mb-1">
                            <div class="flex-1 bg-gray-200 dark:bg-gray-600 h-2 rounded-full">
                                <div class="bg-primary h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="ml-2 text-xs font-medium">${Math.round(percentage)}%</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">${todayCount}/${challenge.target} pushups</span>
                            <button class="join-challenge-btn px-4 py-1.5 text-sm bg-primary text-white rounded-lg" data-challenge-id="${challenge.id}">
                                Join Challenge
                            </button>
                        </div>
                    `;
                    
                    communityContainer.appendChild(challengeEl);
                    
                    challengeEl.querySelector('.join-challenge-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        const challengeId = e.target.getAttribute('data-challenge-id');
                        joinChallenge(challengeId);
                        playSound('click');
                    });
                }
            }
        }
        
        function createNewChallenge() {
            const name = challengeName.value.trim() || 'Custom Challenge';
            const description = challengeDescription.value.trim() || `Complete ${challengeTargetInput.value} pushups`;
            const target = parseInt(challengeTargetInput.value) || 100;
            const endDate = challengeEndDate.value || new Date().toISOString().split('T')[0];
            const isPublic = challengePublic.checked;
            
            const today = new Date().toISOString().split('T')[0];
            const startDate = today;
            
            if (endDate < startDate) {
                showAchievement('End date cannot be before today');
                return;
            }
            
            const newChallengeRef = push(ref(db, 'challenges'));
            set(newChallengeRef, {
                name: name,
                description: description,
                date: startDate,
                endDate: endDate,
                target: target,
                active: true,
                createdBy: userId,
                createdByUsername: username,
                public: isPublic,
                createdAt: serverTimestamp()
            }).then(() => {
                showAchievement('Challenge created successfully!');
                playSound('click');
                
                challengeName.value = '';
                challengeDescription.value = '';
                challengeTargetInput.value = '100';
                challengeEndDate.value = '';
                challengePublic.checked = false;
                
                tabActiveChallenges.click();
            });
        }
        
        function joinChallenge(challengeId) {
            activeChallengeId = challengeId;
            
            get(ref(db, `challenges/${challengeId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const challenge = snapshot.val();
                    challengeTarget = challenge.target;
                    
                    challengeText.textContent = challenge.description || `Do ${challenge.target} pushups today!`;
                    updateChallengeProgress();
                    challengeBanner.classList.remove('hidden');
                    
                    challengeCompleted = todayCount >= challengeTarget;
                    
                    showAchievement('You joined the challenge!');
                    
                    tabActiveChallenges.click();
                }
            });
        }
        
        function deleteChallenge(challengeId) {
            remove(ref(db, `challenges/${challengeId}`)).then(() => {
                showAchievement('Challenge deleted');
                playSound('click');
                
                if (challengeId === activeChallengeId) {
                    activeChallengeId = null;
                    challengeTarget = 0;
                    challengeBanner.classList.add('hidden');
                }
            });
        }
        
        function updateUserStats() {
            const today = new Date().toISOString().split('T')[0];
            
            set(ref(db, `stats/daily/${today}/${userId}`), {
                username: username,
                count: todayCount,
                lastUpdated: Date.now()
            });
            
            set(ref(db, `stats/allTime/${userId}`), {
                username: username,
                count: totalCount,
                lastUpdated: Date.now()
            });
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - 6);
            const weekStartStr = weekStart.toISOString().split('T')[0];
            
            get(ref(db, `stats/weekly/${weekStartStr}/${userId}`)).then((snapshot) => {
                let weeklyCount = 0;
                if (snapshot.exists()) {
                    weeklyCount = snapshot.val().count || 0;
                }
                
                set(ref(db, `stats/weekly/${weekStartStr}/${userId}`), {
                    username: username,
                    count: todayCount + weeklyCount,
                    lastUpdated: Date.now()
                });
            });
            
            const monthStart = new Date();
            monthStart.setDate(1);
            const monthStartStr = monthStart.toISOString().split('T')[0];
            
            get(ref(db, `stats/monthly/${monthStartStr}/${userId}`)).then((snapshot) => {
                let monthlyCount = 0;
                if (snapshot.exists()) {
                    monthlyCount = snapshot.val().count || 0;
                }
                
                set(ref(db, `stats/monthly/${monthStartStr}/${userId}`), {
                    username: username,
                    count: todayCount + monthlyCount,
                    lastUpdated: Date.now()
                });
            });
        }
        
        function updateLeaderboardData(stats) {
            leaderboardData = {today: [], week: [], month: []};
            
            const today = new Date().toISOString().split('T')[0];
            if (stats.daily && stats.daily[today]) {
                const todayStats = stats.daily[today];
                
                const todayArray = Object.keys(todayStats).map(uid => {
                    return {
                        userId: uid,
                        username: todayStats[uid].username || 'Anonymous',
                        count: todayStats[uid].count || 0
                    };
                });
                
                todayArray.sort((a, b) => b.count - a.count);
                
                leaderboardData.today = todayArray;
            }
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - 6);
            const weekStartStr = weekStart.toISOString().split('T')[0];
            
            if (stats.weekly && stats.weekly[weekStartStr]) {
                const weekStats = stats.weekly[weekStartStr];
                
                const weekArray = Object.keys(weekStats).map(uid => {
                    return {
                        userId: uid,
                        username: weekStats[uid].username || 'Anonymous',
                        count: weekStats[uid].count || 0
                    };
                });
                
                weekArray.sort((a, b) => b.count - a.count);
                
                leaderboardData.week = weekArray;
            }
            
            const monthStart = new Date();
            monthStart.setDate(1);
            const monthStartStr = monthStart.toISOString().split('T')[0];
            
            if (stats.monthly && stats.monthly[monthStartStr]) {
                const monthStats = stats.monthly[monthStartStr];
                
                const monthArray = Object.keys(monthStats).map(uid => {
                    return {
                        userId: uid,
                        username: monthStats[uid].username || 'Anonymous',
                        count: monthStats[uid].count || 0
                    };
                });
                
                monthArray.sort((a, b) => b.count - a.count);
                
                leaderboardData.month = monthArray;
            }
            
            if (leaderboardModal.classList.contains('pointer-events-auto')) {
                renderLeaderboard();
            }
        }
        
        function renderLeaderboard() {
            let activeTab;
            if (!leaderboardToday.classList.contains('hidden')) {
                activeTab = 'today';
            } else if (!leaderboardWeek.classList.contains('hidden')) {
                activeTab = 'week';
            } else if (!leaderboardMonth.classList.contains('hidden')) {
                activeTab = 'month';
            }
            
            const container = document.getElementById(`leaderboard-${activeTab}`);
            const loadingElement = document.getElementById(`leaderboard-${activeTab}-loading`);
            
            if (loadingElement) {
                loadingElement.remove();
            }
            
            const existingItems = container.querySelectorAll(':not(#leaderboard-' + activeTab + '-loading)');
            existingItems.forEach(item => item.remove());
            
            const data = leaderboardData[activeTab];
            
            if (!data || data.length === 0) {
                const noDataEl = document.createElement('div');
                noDataEl.className = 'text-center text-sm text-gray-500 dark:text-gray-400';
                noDataEl.textContent = 'No data available';
                container.appendChild(noDataEl);
                return;
            }
            
            let yourRank = data.findIndex(item => item.userId === userId) + 1;
            if (yourRank === 0) yourRank = '-';
            
            if (activeTab === 'today') {
                document.getElementById('your-rank-today').textContent = yourRank;
            } else if (activeTab === 'week') {
                document.getElementById('your-rank-week').textContent = yourRank;
            } else if (activeTab === 'month') {
                document.getElementById('your-rank-month').textContent = yourRank;
            }
            
            data.forEach((user, index) => {
                const rank = index + 1;
                
                const userEl = document.createElement('div');
                userEl.className = 'flex items-center p-3 rounded-lg ' + 
                    (user.userId === userId ? 'bg-primary/10 border border-primary/30' : 'bg-gray-100 dark:bg-gray-700');
                
                let medalClass = '';
                let medalIcon = '';
                if (rank === 1) {
                    medalClass = 'text-yellow-500';
                    medalIcon = '🥇';
                } else if (rank === 2) {
                    medalClass = 'text-gray-400';
                    medalIcon = '🥈';
                } else if (rank === 3) {
                    medalClass = 'text-yellow-700';
                    medalIcon = '🥉';
                }
                
                const hue = stringToHue(user.username || 'Anonymous');
                
                userEl.innerHTML = `
                    <div class="font-bold text-lg w-8 text-center ${medalClass}">${medalIcon || rank}</div>
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold cursor-pointer user-avatar-enhanced ${user.userId in onlineUsers ? 'active' : ''}"
                         style="background-color: hsl(${hue}, 70%, 60%)" data-user-id="${user.userId}">
                        ${(user.username || 'A').charAt(0).toUpperCase()}
                    </div>
                    <div class="ml-3 flex-1 cursor-pointer" data-user-id="${user.userId}">
                        <div class="font-medium">${user.username}${user.userId === userId ? ' (You)' : ''}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            ${user.userId in onlineUsers ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    <div class="font-bold">${user.count}</div>
                `;
                
                container.appendChild(userEl);
                
                if (user.userId !== userId) {
                    const avatarEl = userEl.querySelector(`[data-user-id="${user.userId}"]`);
                    avatarEl.addEventListener('click', () => {
                        if (user.userId in onlineUsers) {
                            showUserProfileView(user.userId);
                            playSound('click');
                        }
                    });
                    
                    const nameEl = userEl.querySelector(`div[data-user-id="${user.userId}"]`);
                    nameEl.addEventListener('click', () => {
                        if (user.userId in onlineUsers) {
                            showUserProfileView(user.userId);
                            playSound('click');
                        }
                    });
                }
            });
        }
        
        function addPushupActivity(userId, username, count) {
            const activitiesRef = ref(db, 'activities');
            push(activitiesRef, {
                type: 'pushup',
                userId: userId,
                username: username,
                count: count,
                timestamp: Date.now()
            });
        }
        
        function addCheerActivity(fromUserId, fromUsername, targetUserId, targetUsername) {
            const activitiesRef = ref(db, 'activities');
            push(activitiesRef, {
                type: 'cheer',
                userId: fromUserId,
                username: fromUsername,
                targetUserId: targetUserId,
                targetUsername: targetUsername,
                timestamp: Date.now()
            });
            
            addActivityMessage(`You cheered ${targetUsername} on! 👍`, 'cheer');
            
            totalCheersGiven++;
        }
        
        function removeInitialMessage() {
            const initialMessage = feedContainer.querySelector('.initial-message');
            if (initialMessage) {
                initialMessage.remove();
            }
        }
        
        function updateOnlineCount() {
            const count = Object.keys(onlineUsers).length + 1;
            onlineCountDisplay.textContent = count;
        }
        
        function addUserElement(userId, username, isSelf = false) {
            if (document.getElementById(`user-${userId}`)) {
                return;
            }
            
            const userEl = document.createElement('div');
            userEl.id = `user-${userId}`;
            userEl.className = `user-badge bg-gray-200 dark:bg-gray-800 rounded-full p-1 shadow-md active ${isSelf ? 'user-avatar-enhanced' : ''}`;
            if (isSelf) {
                userEl.classList.add('border-2', 'border-primary');
            }
            userEl.dataset.userId = userId;
            
            const initials = (username || 'A').charAt(0).toUpperCase();
            const hue = stringToHue(username || userId);
            
            userEl.innerHTML = `
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white"
                     style="background-color: hsl(${hue}, 70%, 60%)">
                    ${initials}
                </div>
                <div class="absolute -bottom-6 left-0 right-0 text-center text-xs opacity-0 transition-opacity whitespace-nowrap overflow-hidden text-ellipsis px-1"
                     style="max-width: 80px;">
                    ${username || 'Anonymous'}${isSelf ? ' (You)' : ''}
                </div>
            `;
            
            userEl.addEventListener('mouseenter', () => {
                userEl.querySelector('div:last-child').classList.add('opacity-100');
            });
            
            userEl.addEventListener('mouseleave', () => {
                userEl.querySelector('div:last-child').classList.remove('opacity-100');
            });
            
            if (!isSelf) {
                userEl.addEventListener('click', () => {
                    showUserDetailsModal(userId);
                    playSound('click');
                });
            }
            
            usersContainer.appendChild(userEl);
        }
        
        function removeUserElement(userId) {
            const userEl = document.getElementById(`user-${userId}`);
            if (userEl) {
                userEl.classList.add('opacity-0');
                setTimeout(() => userEl.remove(), 300);
            }
        }
        
        function animateUserPushup(userId) {
            const userEl = document.getElementById(`user-${userId}`);
            if (userEl) {
                userEl.classList.add('pushup-animation');
                setTimeout(() => {
                    userEl.classList.remove('pushup-animation');
                }, 1000);
            }
        }
        
        function showUserDetailsModal(userId) {
            currentUserDetails = userId;
            
            const userData = onlineUsers[userId];
            if (!userData) return;
            
            updateUserDetailsUI(userData);
            
            userDetailsModal.classList.add('pointer-events-auto');
            userDetailsModal.querySelector('.absolute.inset-0').classList.add('opacity-100');
            userDetailsModal.querySelector('.absolute.right-0').classList.remove('translate-x-full');
            userDetailsModal.querySelector('.absolute.right-0').classList.add('slide-in');
            
            loadUserActivity(userId);
        }
        
        function hideUserDetailsModal() {
            currentUserDetails = null;
            
            userDetailsModal.querySelector('.absolute.right-0').classList.remove('slide-in');
            userDetailsModal.querySelector('.absolute.right-0').classList.add('slide-out');
            
            setTimeout(() => {
                userDetailsModal.classList.remove('pointer-events-auto');
                userDetailsModal.querySelector('.absolute.inset-0').classList.remove('opacity-100');
                userDetailsModal.querySelector('.absolute.right-0').classList.remove('slide-out');
                userDetailsModal.querySelector('.absolute.right-0').classList.add('translate-x-full');
            }, 300);
        }
        
        function showUserProfileView(userId) {
            currentProfileView = userId;
            
            const userData = onlineUsers[userId];
            if (!userData) return;
            
            updateUserProfileView(userData);
            
            userProfileViewModal.classList.add('pointer-events-auto');
            userProfileViewModal.querySelector('.absolute.inset-0').classList.add('opacity-100');
            userProfileViewModal.querySelector('.absolute.right-0').classList.remove('translate-x-full');
            userProfileViewModal.querySelector('.absolute.right-0').classList.add('slide-in');
            
            if (userData.privacyShowActivity !== false) {
                loadUserProfileActivity(userId);
            }
        }
        
        function hideUserProfileView() {
            currentProfileView = null;
            
            userProfileViewModal.querySelector('.absolute.right-0').classList.remove('slide-in');
            userProfileViewModal.querySelector('.absolute.right-0').classList.add('slide-out');
            
            setTimeout(() => {
                userProfileViewModal.classList.remove('pointer-events-auto');
                userProfileViewModal.querySelector('.absolute.inset-0').classList.remove('opacity-100');
                userProfileViewModal.querySelector('.absolute.right-0').classList.remove('slide-out');
                userProfileViewModal.querySelector('.absolute.right-0').classList.add('translate-x-full');
            }, 300);
        }
        
        function updateUserDetailsUI(userData) {
            const initials = (userData.username || 'A').charAt(0).toUpperCase();
            const hue = stringToHue(userData.username || currentUserDetails);
            const userDetailsAvatar = document.getElementById('user-details-avatar');
            const userDetailsName = document.getElementById('user-details-name');
            const userDetailsToday = document.getElementById('user-details-today');
            const userDetailsTotal = document.getElementById('user-details-total');
            const userDetailsProgress = document.getElementById('user-details-progress');
            const userDetailsGoal = document.getElementById('user-details-goal');
            
            userDetailsAvatar.textContent = initials;
            userDetailsAvatar.style.backgroundColor = `hsl(${hue}, 70%, 60%)`;
            
            userDetailsName.textContent = userData.username || 'Anonymous';
            
            userDetailsToday.textContent = userData.todayCount || 0;
            userDetailsTotal.textContent = userData.totalCount || 0;
            
            const goal = userData.goal || 100;
            const count = userData.count || 0;
            const percentage = Math.min(100, (count / goal) * 100);
            userDetailsProgress.style.width = `${percentage}%`;
            userDetailsGoal.textContent = `${count}/${goal}`;
        }
        
        function updateUserProfileView(userData) {
            const initials = (userData.username || 'A').charAt(0).toUpperCase();
            const hue = stringToHue(userData.username || currentProfileView);
            userProfileViewAvatar.textContent = initials;
            userProfileViewAvatar.style.backgroundColor = `hsl(${hue}, 70%, 60%)`;
            userProfileViewName.textContent = userData.username || 'Anonymous';
            
            userProfileViewLevel.textContent = `Level ${userData.level || 1} Pusher`;
            
            userProfileViewStatus.textContent = 'Currently Online';
            
            userProfileViewTodayCount.textContent = userData.todayCount || 0;
            userProfileViewTotalCount.textContent = userData.totalCount || 0;
            
            const goal = userData.goal || 100;
            const count = userData.count || 0;
            const percentage = Math.min(100, (count / goal) * 100);
            userProfileViewProgress.style.width = `${percentage}%`;
            userProfileViewGoal.textContent = `${count}/${goal}`;
            
            if (userData.privacyShowBadges !== false && userData.badges && userData.badges.length > 0) {
                userProfileViewBadges.innerHTML = '';
                
                userData.badges.forEach(badgeId => {
                    const badge = badgeDefinitions.find(b => b.id === badgeId);
                    if (badge) {
                        const badgeEl = document.createElement('div');
                        badgeEl.className = 'profile-badge-item';
                        badgeEl.innerHTML = `
                            <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mb-1">
                                <i class="fas ${badge.icon} text-primary text-lg"></i>
                            </div>
                            <p class="text-xs font-medium text-center">${badge.name}</p>
                        `;
                        userProfileViewBadges.appendChild(badgeEl);
                    }
                });
            } else {
                userProfileViewBadges.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400 col-span-3">User has privacy enabled</div>';
            }
            
            if (userData.privacyShowActivity === false) {
                userProfileViewActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">User has privacy enabled</div>';
            }
        }
        
        function loadUserActivity(userId) {
            const userDetailsActivity = document.getElementById('user-details-activity');
            userDetailsActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">Loading activity...</div>';
            
            const userData = onlineUsers[userId];
            if (userData && userData.privacyShowActivity === false) {
                userDetailsActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">User has privacy enabled</div>';
                return;
            }
            
            const activitiesQuery = query(
                ref(db, 'activities'),
                orderByChild('userId'),
                limitToLast(10)
            );
            
            get(activitiesQuery).then((snapshot) => {
                userDetailsActivity.innerHTML = '';
                
                if (snapshot.exists()) {
                    let activities = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const activity = childSnapshot.val();
                        if (activity.userId === userId) {
                            activities.push({
                                ...activity,
                                id: childSnapshot.key
                            });
                        }
                    });
                    
                    activities.sort((a, b) => b.timestamp - a.timestamp);
                    
                    activities = activities.slice(0, 5);
                    
                    if (activities.length === 0) {
                        userDetailsActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No recent activity</div>';
                        return;
                    }
                    
                    activities.forEach(activity => {
                        const activityEl = document.createElement('div');
                        activityEl.className = 'text-sm';
                        
                        const time = new Date(activity.timestamp);
                        const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        if (activity.type === 'pushup') {
                            activityEl.innerHTML = `<span class="text-primary">${timeStr}: Did a pushup (count: ${activity.count})</span>`;
                        } else if (activity.type === 'cheer') {
                            activityEl.innerHTML = `<span class="text-accent">${timeStr}: Cheered for ${activity.targetUsername}</span>`;
                        }
                        
                        userDetailsActivity.appendChild(activityEl);
                    });
                } else {
                    userDetailsActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No recent activity</div>';
                }
            }).catch(err => {
                console.error('Error getting activities:', err);
                userDetailsActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">Error loading activity</div>';
            });
        }
        
        function loadUserProfileActivity(userId) {
            userProfileViewActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">Loading activity...</div>';
            
            const activitiesQuery = query(
                ref(db, 'activities'),
                orderByChild('userId'),
                limitToLast(10)
            );
            
            get(activitiesQuery).then((snapshot) => {
                userProfileViewActivity.innerHTML = '';
                
                if (snapshot.exists()) {
                    let activities = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const activity = childSnapshot.val();
                        if (activity.userId === userId) {
                            activities.push({
                                ...activity,
                                id: childSnapshot.key
                            });
                        }
                    });
                    
                    activities.sort((a, b) => b.timestamp - a.timestamp);
                    
                    activities = activities.slice(0, 5);
                    
                    if (activities.length === 0) {
                        userProfileViewActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No recent activity</div>';
                        return;
                    }
                    
                    activities.forEach(activity => {
                        const activityEl = document.createElement('div');
                        activityEl.className = 'text-sm';
                        
                        const time = new Date(activity.timestamp);
                        const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        if (activity.type === 'pushup') {
                            activityEl.innerHTML = `<span class="text-primary">${timeStr}: Did a pushup (count: ${activity.count})</span>`;
                        } else if (activity.type === 'cheer') {
                            activityEl.innerHTML = `<span class="text-accent">${timeStr}: Cheered for ${activity.targetUsername}</span>`;
                        }
                        
                        userProfileViewActivity.appendChild(activityEl);
                    });
                } else {
                    userProfileViewActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">No recent activity</div>';
                }
            }).catch(err => {
                console.error('Error getting activities:', err);
                userProfileViewActivity.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">Error loading activity</div>';
            });
        }
        
        function addActivityMessage(message, type = 'system') {
            const msgEl = document.createElement('div');
            msgEl.className = 'text-xs';
            
            if (type === 'system') {
                msgEl.className += ' text-gray-500 dark:text-gray-400';
            } else if (type === 'join') {
                msgEl.className += ' text-green-600 dark:text-green-400';
            } else if (type === 'leave') {
                msgEl.className += ' text-red-600 dark:text-red-400';
            } else if (type === 'pushup') {
                msgEl.className += ' text-primary';
            } else if (type === 'achievement') {
                msgEl.className += ' text-yellow-600 dark:text-yellow-400 font-medium';
            } else if (type === 'cheer') {
                msgEl.className += ' text-accent';
            }
            
            msgEl.textContent = message;
            
            if (feedContainer.firstChild) {
                feedContainer.insertBefore(msgEl, feedContainer.firstChild);
            } else {
                feedContainer.appendChild(msgEl);
            }
            
            while (feedContainer.children.length > 15) {
                feedContainer.removeChild(feedContainer.lastChild);
            }
        }
        
        function stringToHue(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash % 360;
        }
        
        function togglePauseMode() {
            isPaused = !isPaused;
            
            if (isPaused) {
                pauseToggle.innerHTML = '<i class="fas fa-pause text-red-500"></i>';
                counterDisplay.classList.add('paused');
                document.body.classList.add('is-paused');
                playSound('click');
            } else {
                pauseToggle.innerHTML = '<i class="fas fa-play text-gray-600 dark:text-gray-300"></i>';
                counterDisplay.classList.remove('paused');
                document.body.classList.remove('is-paused');
                playSound('click');
            }
        }
        
        function showConfirmation(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmedCallback = callback;
            
            confirmModal.classList.add('opacity-100', 'pointer-events-auto');
            playSound('click');
        }
        
        function hideConfirmation() {
            confirmModal.classList.remove('opacity-100', 'pointer-events-auto');
            confirmedCallback = null;
        }
        
        function clearAllData() {
            if (userRef) {
                set(userRef, null);
            }
            
            const today = new Date().toISOString().split('T')[0];
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - 6);
            const weekStartStr = weekStart.toISOString().split('T')[0];
            const monthStart = new Date();
            monthStart.setDate(1);
            const monthStartStr = monthStart.toISOString().split('T')[0];
            
            remove(ref(db, `stats/daily/${today}/${userId}`));
            remove(ref(db, `stats/weekly/${weekStartStr}/${userId}`));
            remove(ref(db, `stats/monthly/${monthStartStr}/${userId}`));
            remove(ref(db, `stats/allTime/${userId}`));
            
            localStorage.removeItem('pushup_username');
            localStorage.removeItem('pushup_today');
            localStorage.removeItem('pushup_total');
            localStorage.removeItem('pushup_date');
            localStorage.removeItem('pushup_streak');
            localStorage.removeItem('pushup_max');
            localStorage.removeItem('pushup_workout_days');
            localStorage.removeItem('pushup_challenges_completed');
            localStorage.removeItem('pushup_longest_streak');
            localStorage.removeItem('pushup_total_time');
            localStorage.removeItem('pushup_level');
            localStorage.removeItem('pushup_xp');
            localStorage.removeItem('pushup_badges');
            localStorage.removeItem('pushup_first_join');
            
            const soundEnabled = localStorage.getItem('pushup_sound_enabled');
            const volumeValue = localStorage.getItem('pushup_volume');
            const goalValue = localStorage.getItem('pushup_goal');
            const anticheatValue = localStorage.getItem('pushup_anticheat');
            const colorTheme = localStorage.getItem('color-theme');
            const privacyBadges = localStorage.getItem('pushup_privacy_badges');
            const privacyActivity = localStorage.getItem('pushup_privacy_activity');
            
            localStorage.clear();
            
            if (soundEnabled !== null) localStorage.setItem('pushup_sound_enabled', soundEnabled);
            if (volumeValue !== null) localStorage.setItem('pushup_volume', volumeValue);
            if (goalValue !== null) localStorage.setItem('pushup_goal', goalValue);
            if (anticheatValue !== null) localStorage.setItem('pushup_anticheat', anticheatValue);
            if (colorTheme !== null) localStorage.setItem('color-theme', colorTheme);
            if (privacyBadges !== null) localStorage.setItem('pushup_privacy_badges', privacyBadges);
            if (privacyActivity !== null) localStorage.setItem('pushup_privacy_activity', privacyActivity);
            
            showAchievement('All data cleared successfully');
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
        
        function showLeaderboardModal() {
            leaderboardModal.classList.add('pointer-events-auto');
            leaderboardModal.querySelector('.absolute.inset-0').classList.add('opacity-100');
            leaderboardModal.querySelector('.absolute.right-0').classList.remove('translate-x-full');
            leaderboardModal.querySelector('.absolute.right-0').classList.add('slide-in');
            
            renderLeaderboard();
            
            playSound('click');
        }
        
        function hideLeaderboardModal() {
            leaderboardModal.querySelector('.absolute.right-0').classList.remove('slide-in');
            leaderboardModal.querySelector('.absolute.right-0').classList.add('slide-out');
            
            setTimeout(() => {
                leaderboardModal.classList.remove('pointer-events-auto');
                leaderboardModal.querySelector('.absolute.inset-0').classList.remove('opacity-100');
                leaderboardModal.querySelector('.absolute.right-0').classList.remove('slide-out');
                leaderboardModal.querySelector('.absolute.right-0').classList.add('translate-x-full');
            }, 300);
            
            playSound('click');
        }
        
        function showChallengesModal() {
            challengesModal.classList.add('pointer-events-auto');
            challengesModal.querySelector('.absolute.inset-0').classList.add('opacity-100');
            challengesModal.querySelector('.absolute.right-0').classList.remove('translate-x-full');
            challengesModal.querySelector('.absolute.right-0').classList.add('slide-in');
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            challengeEndDate.value = tomorrow.toISOString().split('T')[0];
            
            playSound('click');
        }
        
        function hideChallengesModal() {
            challengesModal.querySelector('.absolute.right-0').classList.remove('slide-in');
            challengesModal.querySelector('.absolute.right-0').classList.add('slide-out');
            
            setTimeout(() => {
                challengesModal.classList.remove('pointer-events-auto');
                challengesModal.querySelector('.absolute.inset-0').classList.remove('opacity-100');
                challengesModal.querySelector('.absolute.right-0').classList.remove('slide-out');
                challengesModal.querySelector('.absolute.right-0').classList.add('translate-x-full');
            }, 300);
            
            playSound('click');
        }
        
        function showProfileModal() {
            profileModal.classList.add('pointer-events-auto');
            profileModal.querySelector('.absolute.inset-0').classList.add('opacity-100');
            profileModal.querySelector('.absolute.right-0').classList.remove('translate-x-full');
            profileModal.querySelector('.absolute.right-0').classList.add('slide-in');
            
            updateProfileScreen();
            
            playSound('click');
        }
        
        function hideProfileModal() {
            profileModal.querySelector('.absolute.right-0').classList.remove('slide-in');
            profileModal.querySelector('.absolute.right-0').classList.add('slide-out');
            
            setTimeout(() => {
                profileModal.classList.remove('pointer-events-auto');
                profileModal.querySelector('.absolute.inset-0').classList.remove('opacity-100');
                profileModal.querySelector('.absolute.right-0').classList.remove('slide-out');
                profileModal.querySelector('.absolute.right-0').classList.add('translate-x-full');
            }, 300);
            
            playSound('click');
        }
        
        function showCustomGoalModal() {
            selectedCustomGoal = null;
            quickGoalBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            customGoalInput.value = '';
            
            customGoalModal.classList.add('opacity-100', 'pointer-events-auto');
            
            playSound('click');
        }
        
        function hideCustomGoalModal() {
            customGoalModal.classList.remove('opacity-100', 'pointer-events-auto');
            
            playSound('click');
        }
        
        function toggleTheme(themeName) {
            if (themeName === 'light' || (!themeName && document.documentElement.classList.contains('dark'))) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
                highlightThemeButton('light');
            } else if (themeName === 'dark' || (!themeName && !document.documentElement.classList.contains('dark'))) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
                highlightThemeButton('dark');
            } else if (themeName === 'auto') {
                localStorage.removeItem('color-theme');
                highlightThemeButton('auto');
                
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            
            playSound('click');
        }
        
        function resetCounter() {
            count = 0;
            counterDisplay.textContent = count;
            sessionCountDisplay.textContent = count;
            
            startTimer();
            
            updateProgressRing();
            
            lastTapTime = 0;
            tapHistory = [];
            suspiciousActivityCount = 0;
            
            counterDisplay.classList.add('scale-75');
            setTimeout(() => counterDisplay.classList.remove('scale-75'), 300);
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
            }
            
            addActivityMessage('You reset your counter!', 'system');
            
            playSound('click');
        }
        
        function setGoal() {
            showCustomGoalModal();
        }
        
        function applyCustomGoal() {
            let newGoal;
            
            if (selectedCustomGoal !== null) {
                newGoal = selectedCustomGoal;
            } else if (customGoalInput.value.trim() !== '') {
                newGoal = parseInt(customGoalInput.value.trim());
                
                if (isNaN(newGoal) || newGoal < 1) {
                    showAchievement('Please enter a valid number');
                    return;
                }
                
                if (newGoal > 9999) {
                    newGoal = 9999;
                }
            } else {
                showAchievement('Please select or enter a goal');
                return;
            }
            
            goal = newGoal;
            
            goalDisplay.textContent = goal;
            
            updateProgressRing();
            
            localStorage.setItem('pushup_goal', goal.toString());
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
            }
            
            addActivityMessage(`You set a new goal: ${goal} pushups!`, 'system');
            
            hideCustomGoalModal();
            
            playSound('click');
        }
        
        function shareWorkout() {
            const shareText = `I just completed ${count} pushups! Join me on Pushup Counter Pro!`;
            const shareUrl = 'https://pushupscounterpro.netlify.app';
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Pushup Workout',
                    text: shareText,
                    url: shareUrl
                }).catch(err => {
                    console.error('Share failed:', err);
                    fallbackShare(shareText, shareUrl);
                });
            } else {
                fallbackShare(shareText, shareUrl);
            }
            
            playSound('click');
        }
        
        function fallbackShare(shareText, shareUrl) {
            const fullText = shareText + ' ' + shareUrl;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullText).then(() => {
                    showAchievement('Copied to clipboard!');
                }).catch(err => {
                    console.error('Clipboard failed:', err);
                    showAchievement('Share: ' + fullText);
                });
            } else {
                showAchievement('Share: ' + fullText);
            }
        }
        
        function shareUserProfile(userId) {
            const userData = onlineUsers[userId];
            if (!userData) return;
            
            const shareText = `Check out ${userData.username}'s pushup workout! They've done ${userData.totalCount} pushups in total!`;
            const shareUrl = 'https://pushupscounterpro.netlify.app';
            
            if (navigator.share) {
                navigator.share({
                    title: 'Pushup Workout',
                    text: shareText,
                    url: shareUrl
                }).catch(err => {
                    console.error('Share failed:', err);
                    fallbackShare(shareText, shareUrl);
                });
            } else {
                fallbackShare(shareText, shareUrl);
            }
            
            playSound('click');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Fullscreen failed:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
            
            playSound('click');
        }
        
        function updateUsername(newUsername) {
            if (!newUsername.trim()) {
                showAchievement('Username cannot be empty');
                return false;
            }
            
            username = newUsername.trim();
            
            localStorage.setItem('pushup_username', username);
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
                
                updateUserStats();
            }
            
            updateProfileScreen();
            
            showAchievement('Username updated!');
            
            return true;
        }
        
        // Event Listeners
        
        pauseToggle.addEventListener('click', togglePauseMode);
        
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        touchArea.addEventListener('touchstart', handleTouchStart, { passive: false });
        touchArea.addEventListener('touchend', handleTouchEnd, { passive: false });
        touchArea.addEventListener('mousedown', handleTouchStart, { passive: false });
        touchArea.addEventListener('mouseup', handleTouchEnd, { passive: false });
        touchArea.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        
        resetBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            resetCounter();
        });
        
        goalBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            setGoal();
        });
        
        shareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            shareWorkout();
        });
        
        quickGoalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                quickGoalBtns.forEach(b => b.classList.remove('active', 'bg-primary', 'text-white'));
                
                btn.classList.add('active', 'bg-primary', 'text-white');
                
                selectedCustomGoal = parseInt(btn.dataset.goal);
                
                customGoalInput.value = '';
                
                playSound('click');
            });
        });
        
        customGoalInput.addEventListener('input', () => {
            if (customGoalInput.value.trim() !== '') {
                selectedCustomGoal = null;
                quickGoalBtns.forEach(btn => {
                    btn.classList.remove('active', 'bg-primary', 'text-white');
                });
            }
        });
        
        saveCustomGoal.addEventListener('click', applyCustomGoal);
        cancelCustomGoal.addEventListener('click', hideCustomGoalModal);
        
        leaderboardBtn.addEventListener('click', showLeaderboardModal);
        challengesBtn.addEventListener('click', showChallengesModal);
        profileBtn.addEventListener('click', showProfileModal);
        
        closeLeaderboard.addEventListener('click', hideLeaderboardModal);
        closeChallenges.addEventListener('click', hideChallengesModal);
        closeProfile.addEventListener('click', hideProfileModal);
        closeUserDetails.addEventListener('click', hideUserDetailsModal);
        closeUserProfileView.addEventListener('click', hideUserProfileView);
        
        document.getElementById('cheer-user-btn').addEventListener('click', () => {
            if (currentUserDetails) {
                const targetUser = onlineUsers[currentUserDetails];
                
                if (targetUser) {
                    addCheerActivity(userId, username, currentUserDetails, targetUser.username);
                    
                    document.getElementById('cheer-user-btn').classList.add('cheer-animation');
                    setTimeout(() => {
                        document.getElementById('cheer-user-btn').classList.remove('cheer-animation');
                    }, 1000);
                    
                    playSound('cheer');
                    
                    setTimeout(() => {
                        hideUserDetailsModal();
                    }, 1500);
                }
            }
        });
        
        document.getElementById('view-profile-btn').addEventListener('click', () => {
            if (currentUserDetails) {
                hideUserDetailsModal();
                
                setTimeout(() => {
                    showUserProfileView(currentUserDetails);
                }, 300);
            }
        });
        
        cheerUserProfileBtn.addEventListener('click', () => {
            if (currentProfileView) {
                const targetUser = onlineUsers[currentProfileView];
                
                if (targetUser) {
                    addCheerActivity(userId, username, currentProfileView, targetUser.username);
                    
                    cheerUserProfileBtn.classList.add('cheer-animation');
                    setTimeout(() => {
                        cheerUserProfileBtn.classList.remove('cheer-animation');
                    }, 1000);
                    
                    playSound('cheer');
                    
                    setTimeout(() => {
                        hideUserProfileView();
                    }, 1500);
                }
            }
        });
        
        shareUserProfileBtn.addEventListener('click', () => {
            if (currentProfileView) {
                shareUserProfile(currentProfileView);
            }
        });
        
        cancelConfirm.addEventListener('click', hideConfirmation);
        okConfirm.addEventListener('click', () => {
            if (confirmedCallback) {
                confirmedCallback();
            }
            hideConfirmation();
        });
        
        saveUsernameBtn.addEventListener('click', () => {
            const updated = updateUsername(settingsUsername.value);
            if (updated) {
                achievementToast.style.zIndex = "9999";
                setTimeout(() => {
                    achievementToast.style.zIndex = "50";
                }, 3000);
            }
        });
        
        clearDataBtn.addEventListener('click', () => {
            showConfirmation('Clear All Data', 
                'Are you sure you want to clear all your data? This will permanently delete your workout history, challenges, and progress. This action CANNOT be undone.', 
                clearAllData);
        });
        
        themeLightBtn.addEventListener('click', () => toggleTheme('light'));
        themeDarkBtn.addEventListener('click', () => toggleTheme('dark'));
        themeAutoBtn.addEventListener('click', () => toggleTheme('auto'));
        
        soundToggle.addEventListener('change', () => {
            isSoundEnabled = soundToggle.checked;
            localStorage.setItem('pushup_sound_enabled', isSoundEnabled);
            
            if (isSoundEnabled) {
                playSound('click');
            }
        });
        
        volumeSlider.addEventListener('input', () => {
            volume = volumeSlider.value / 100;
            localStorage.setItem('pushup_volume', volume);
            
            if (isSoundEnabled) {
                playSound('click');
            }
        });
        
        defaultGoalSelect.addEventListener('change', () => {
            goal = parseInt(defaultGoalSelect.value);
            localStorage.setItem('pushup_goal', goal);
            goalDisplay.textContent = goal;
            updateProgressRing();
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
            }
            
            playSound('click');
        });
        
        anticheatToggle.addEventListener('change', () => {
            showAnticheatReminders = anticheatToggle.checked;
            localStorage.setItem('pushup_anticheat', showAnticheatReminders);
            
            playSound('click');
        });
        
        privacyBadgesToggle.addEventListener('change', () => {
            privacyShowBadges = privacyBadgesToggle.checked;
            localStorage.setItem('pushup_privacy_badges', privacyShowBadges);
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
            }
            
            playSound('click');
        });
        
        privacyActivityToggle.addEventListener('change', () => {
            privacyShowActivity = privacyActivityToggle.checked;
            localStorage.setItem('pushup_privacy_activity', privacyShowActivity);
            
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
            }
            
            playSound('click');
        });
        
        // Tab navigation for all modals
        tabToday.addEventListener('click', () => {
            [tabToday, tabWeek, tabMonth].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabToday.classList.add('border-primary', 'text-primary');
            tabToday.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [leaderboardToday, leaderboardWeek, leaderboardMonth].forEach(content => {
                content.classList.add('hidden');
            });
            leaderboardToday.classList.remove('hidden');
            
            renderLeaderboard();
            playSound('click');
        });
        
        tabWeek.addEventListener('click', () => {
            [tabToday, tabWeek, tabMonth].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabWeek.classList.add('border-primary', 'text-primary');
            tabWeek.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [leaderboardToday, leaderboardWeek, leaderboardMonth].forEach(content => {
                content.classList.add('hidden');
            });
            leaderboardWeek.classList.remove('hidden');
            
            renderLeaderboard();
            playSound('click');
        });
        
        tabMonth.addEventListener('click', () => {
            [tabToday, tabWeek, tabMonth].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabMonth.classList.add('border-primary', 'text-primary');
            tabMonth.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [leaderboardToday, leaderboardWeek, leaderboardMonth].forEach(content => {
                content.classList.add('hidden');
            });
            leaderboardMonth.classList.remove('hidden');
            
            renderLeaderboard();
            playSound('click');
        });
        
        tabActiveChallenges.addEventListener('click', () => {
            [tabActiveChallenges, tabCommunityChallenges, tabCreateChallenge].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabActiveChallenges.classList.add('border-primary', 'text-primary');
            tabActiveChallenges.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [activeChallenges, communityChallenges, createChallenge].forEach(content => {
                content.classList.add('hidden');
            });
            activeChallenges.classList.remove('hidden');
            
            playSound('click');
        });
        
        tabCommunityChallenges.addEventListener('click', () => {
            [tabActiveChallenges, tabCommunityChallenges, tabCreateChallenge].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabCommunityChallenges.classList.add('border-primary', 'text-primary');
            tabCommunityChallenges.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [activeChallenges, communityChallenges, createChallenge].forEach(content => {
                content.classList.add('hidden');
            });
            communityChallenges.classList.remove('hidden');
            
            playSound('click');
        });
        
        tabCreateChallenge.addEventListener('click', () => {
            [tabActiveChallenges, tabCommunityChallenges, tabCreateChallenge].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabCreateChallenge.classList.add('border-primary', 'text-primary');
            tabCreateChallenge.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [activeChallenges, communityChallenges, createChallenge].forEach(content => {
                content.classList.add('hidden');
            });
            createChallenge.classList.remove('hidden');
            
            playSound('click');
        });
        
        tabProfileStats.addEventListener('click', () => {
            [tabProfileStats, tabProfileBadges, tabProfileHistory, tabProfileSettings].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabProfileStats.classList.add('border-primary', 'text-primary');
            tabProfileStats.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [profileStats, profileBadges, profileHistory, profileSettings].forEach(content => {
                content.classList.add('hidden');
            });
            profileStats.classList.remove('hidden');
            
            playSound('click');
        });
        
        tabProfileBadges.addEventListener('click', () => {
            [tabProfileStats, tabProfileBadges, tabProfileHistory, tabProfileSettings].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabProfileBadges.classList.add('border-primary', 'text-primary');
            tabProfileBadges.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [profileStats, profileBadges, profileHistory, profileSettings].forEach(content => {
                content.classList.add('hidden');
            });
            profileBadges.classList.remove('hidden');
            
            playSound('click');
        });
        
        tabProfileHistory.addEventListener('click', () => {
            [tabProfileStats, tabProfileBadges, tabProfileHistory, tabProfileSettings].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabProfileHistory.classList.add('border-primary', 'text-primary');
            tabProfileHistory.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [profileStats, profileBadges, profileHistory, profileSettings].forEach(content => {
                content.classList.add('hidden');
            });
            profileHistory.classList.remove('hidden');
            
            playSound('click');
        });
        
        tabProfileSettings.addEventListener('click', () => {
            [tabProfileStats, tabProfileBadges, tabProfileHistory, tabProfileSettings].forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            tabProfileSettings.classList.add('border-primary', 'text-primary');
            tabProfileSettings.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            [profileStats, profileBadges, profileHistory, profileSettings].forEach(content => {
                content.classList.add('hidden');
            });
            profileSettings.classList.remove('hidden');
            
            settingsUsername.value = username;
            
            playSound('click');
        });
        
        submitChallenge.addEventListener('click', createNewChallenge);
        
        usernameSubmit.addEventListener('click', () => {
            username = usernameInput.value.trim() || 'Anonymous';
            localStorage.setItem('pushup_username', username);
            
            usernameModal.classList.remove('opacity-100', 'pointer-events-auto');
            usernameModal.classList.add('opacity-0', 'pointer-events-none');
            
            initFirebase();
            
            startTimer();
            
            playSound('click');
        });
        
        startWorkout.addEventListener('click', () => {
            welcomeMessage.classList.add('opacity-0', 'pointer-events-none');
            
            if (!username) {
                setTimeout(() => {
                    usernameModal.classList.add('opacity-100', 'pointer-events-auto');
                    usernameInput.focus();
                }, 500);
            } else {
                initFirebase();
                startTimer();
            }
            
            playSound('click');
        });
        
        setInterval(() => {
            if (userRef) {
                set(userRef, {
                    username: username,
                    count: count,
                    todayCount: todayCount,
                    totalCount: totalCount,
                    goal: goal,
                    lastActive: Date.now(),
                    pushup: false,
                    level: userLevel,
                    badges: badgesUnlocked,
                    privacyShowBadges: privacyShowBadges,
                    privacyShowActivity: privacyShowActivity
                });
            }
        }, 30000);
        
        setInterval(() => {
            const activitiesRef = ref(db, 'activities');
            onValue(activitiesRef, (snapshot) => {
                if (snapshot.exists()) {
                    const activities = snapshot.val();
                    const now = Date.now();
                    
                    for (const id in activities) {
                        const activity = activities[id];
                        if (now - activity.timestamp > 300000) {
                            set(ref(db, `activities/${id}`), null);
                        }
                    }
                }
            }, { onlyOnce: true });
        }, 60000);
        
        document.addEventListener('click', (e) => {
            if (leaderboardModal.classList.contains('pointer-events-auto')) {
                const modalContent = leaderboardModal.querySelector('.absolute.right-0');
                const closeBtn = leaderboardModal.querySelector('#close-leaderboard');
                
                if (!modalContent.contains(e.target) && !closeBtn.contains(e.target) && !leaderboardBtn.contains(e.target)) {
                    hideLeaderboardModal();
                }
            }
            
            if (challengesModal.classList.contains('pointer-events-auto')) {
                const modalContent = challengesModal.querySelector('.absolute.right-0');
                const closeBtn = challengesModal.querySelector('#close-challenges');
                
                if (!modalContent.contains(e.target) && !closeBtn.contains(e.target) && !challengesBtn.contains(e.target)) {
                    hideChallengesModal();
                }
            }
            
            if (profileModal.classList.contains('pointer-events-auto')) {
                const modalContent = profileModal.querySelector('.absolute.right-0');
                const closeBtn = profileModal.querySelector('#close-profile');
                
                if (!modalContent.contains(e.target) && !closeBtn.contains(e.target) && !profileBtn.contains(e.target)) {
                    hideProfileModal();
                }
            }
            
            if (userDetailsModal.classList.contains('pointer-events-auto')) {
                const modalContent = userDetailsModal.querySelector('.absolute.right-0');
                const closeBtn = userDetailsModal.querySelector('#close-user-details');
                
                if (!modalContent.contains(e.target) && !closeBtn.contains(e.target) && !e.target.closest('.user-badge')) {
                    hideUserDetailsModal();
                }
            }
            
            if (userProfileViewModal.classList.contains('pointer-events-auto')) {
                const modalContent = userProfileViewModal.querySelector('.absolute.right-0');
                const closeBtn = userProfileViewModal.querySelector('#close-user-profile-view');
                
                if (!modalContent.contains(e.target) && !closeBtn.contains(e.target) && !document.getElementById('view-profile-btn')?.contains(e.target)) {
                    hideUserProfileView();
                }
            }
            
            if (customGoalModal.classList.contains('pointer-events-auto')) {
                const modalContent = customGoalModal.querySelector('.bg-white');
                
                if (!modalContent.contains(e.target) && !goalBtn.contains(e.target)) {
                    hideCustomGoalModal();
                }
            }
            
            if (confirmModal.classList.contains('pointer-events-auto')) {
                const modalContent = confirmModal.querySelector('.bg-white');
                
                if (!modalContent.contains(e.target) && !clearDataBtn.contains(e.target)) {
                    hideConfirmation();
                }
            }
        });
        
        window.addEventListener('beforeunload', () => {
            if (userRef) {
                set(userRef, null);
            }
        });
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('color-theme')) {
                if (e.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        });
        
        function initApp() {
            loadSavedData();
            setThemePreference();
            goalDisplay.textContent = goal;
        }
        
        initApp();
    </script>
</body>
</html>
